<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é›†å®¢ãƒ•ã‚©ãƒ­ãƒ¼ãƒ„ãƒ¼ãƒ«ï½œã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #2c4a72;
    --primary-light: #3d6699;
    --accent: #2e8a6e;
    --accent-light: #e4f2ee;
    --warning: #b07a3a;
    --warning-light: #f4ede0;
    --danger: #a84545;
    --danger-light: #f0e8e8;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-400: #94a3b8;
    --gray-600: #475569;
    --gray-800: #1e293b;
    --white: #ffffff;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--gray-50);
    color: var(--gray-800);
    min-height: 100vh;
  }

  /* ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== */
  #login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #2c4a72 0%, #3d6699 50%, #2e8a6e 100%);
    padding: 20px;
  }

  .login-card {
    background: var(--white);
    border-radius: 20px;
    padding: 48px 40px;
    width: 100%;
    max-width: 400px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }

  .login-logo {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-400);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .login-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 6px;
    line-height: 1.4;
  }
  .login-subtitle {
    font-size: 12px;
    color: var(--gray-400);
    margin-bottom: 28px;
  }

  .login-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-600);
    text-align: left;
    margin-bottom: 8px;
  }

  .login-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-sm);
    font-size: 16px;
    font-family: 'Inter', sans-serif;
    color: var(--gray-800);
    transition: border-color 0.2s;
    outline: none;
    margin-bottom: 20px;
  }

  .login-input:focus { border-color: var(--primary-light); }

  .login-btn {
    width: 100%;
    padding: 14px;
    background: var(--primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-weight: 700;
    font-family: 'Noto Sans JP', sans-serif;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }

  .login-btn:hover { background: var(--primary-light); transform: translateY(-1px); }
  .login-btn:active { transform: translateY(0); }

  .login-error {
    margin-top: 16px;
    padding: 12px;
    background: var(--danger-light);
    border-radius: var(--radius-sm);
    color: var(--danger);
    font-size: 13px;
    display: none;
  }

  /* ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ===== */
  #dashboard { display: none; }

  .top-bar {
    background: var(--primary);
    color: var(--white);
    padding: 0 24px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-md);
  }

  .top-bar-left {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  .top-bar-right {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .contact-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .contact-btn:hover { opacity: 0.85; }
  .contact-btn.line { background: #06C755; color: white; }
  .contact-btn.mail { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); }

  .logout-btn {
    background: none;
    border: 1px solid rgba(255,255,255,0.4);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .logout-btn:hover { background: rgba(255,255,255,0.15); }

  .main-content {
    max-width: 1000px;
    margin: 0 auto;
    padding: 24px 16px 60px;
  }

  /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ ===== */
  .header-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 24px 28px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--primary);
  }

  .salon-name {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
  }

  .data-date {
    font-size: 12px;
    color: var(--gray-400);
    margin-bottom: 16px;
  }

  .rank-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .rank-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 10px 20px;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 700;
  }

  .rank-badge .rank-num {
    font-size: 24px;
    font-family: 'Inter', sans-serif;
  }

  .search-point-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--accent-light);
    color: var(--accent);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
  }

  /* ===== é”æˆçŠ¶æ³ã‚µãƒãƒªãƒ¼ ===== */
  .summary-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .summary-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
    box-shadow: var(--shadow-sm);
  }

  .summary-num {
    font-size: 28px;
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    line-height: 1;
    margin-bottom: 4px;
  }

  .summary-label { font-size: 12px; color: var(--gray-600); }
  .summary-card.achieved .summary-num { color: var(--accent); }
  .summary-card.unachieved .summary-num { color: var(--danger); }
  .summary-card.total .summary-num { color: var(--primary); }

  /* ===== ãƒ‹ãƒ¼ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
  .needs-section {
    margin-bottom: 20px;
  }

  .needs-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 20px;
    border-radius: var(--radius) var(--radius) 0 0;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    justify-content: space-between;
    user-select: none;
  }
  .needs-header-label { display: flex; align-items: center; gap: 10px; }
  .needs-chevron { font-size: 11px; opacity: 0.8; transition: transform 0.2s; }
  .needs-section.collapsed .needs-chevron { transform: rotate(-90deg); }
  .needs-section.collapsed .needs-body { display: none; }
  .needs-section.collapsed .needs-header {
    border-radius: var(--radius);
  }

  .needs-header.search { background: linear-gradient(90deg, #1e3352, #3d6699); color: white; }
  .needs-header.click { background: linear-gradient(90deg, #1a4a3a, #2e8a6e); color: white; }
  .needs-header.reserve { background: linear-gradient(90deg, #4a3020, #b07a3a); color: white; }

  .needs-emoji { font-size: 20px; }

  .needs-body {
    background: var(--white);
    border-radius: 0 0 var(--radius) var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  /* ===== KPIã‚¢ã‚¤ãƒ†ãƒ  ===== */
  .kpi-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 20px;
    border-bottom: 1px solid var(--gray-100);
    transition: background 0.15s;
  }

  .kpi-item:last-child { border-bottom: none; }
  .kpi-item:hover { background: var(--gray-50); }
  .kpi-item.unachieved { background: #f5f7fa; }

  .kpi-status {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .kpi-status.ok { background: var(--accent-light); color: var(--accent); }
  .kpi-status.ng { background: var(--danger-light); color: var(--danger); }

  .kpi-main { flex: 1; min-width: 0; }

  .kpi-name-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
    flex-wrap: wrap;
  }

  .kpi-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
  }

  .kpi-point-badge {
    font-size: 10px;
    font-weight: 700;
    background: #dce8f5;
    color: #2d4a6e;
    padding: 2px 7px;
    border-radius: 10px;
    white-space: nowrap;
  }

  .kpi-values {
    font-size: 12px;
    color: var(--gray-400);
  }

  .kpi-values .current {
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
  }

  .kpi-values .current.ok { color: var(--accent); }
  .kpi-values .current.ng { color: var(--danger); }

  /* ===== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœãƒƒã‚¯ã‚¹ ===== */
  .action-box {
    margin: 8px 0 4px 0;
    padding: 12px 14px;
    background: var(--warning-light);
    border-left: 3px solid var(--warning);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    font-size: 13px;
    color: var(--gray-800);
  }

  .action-title {
    font-weight: 700;
    color: var(--warning);
    margin-bottom: 6px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .action-links {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .action-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    background: var(--white);
    border: 1px solid var(--warning);
    color: var(--warning);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
    cursor: pointer;
  }

  .action-link:hover {
    background: var(--warning);
    color: white;
  }

  .action-link.primary {
    background: var(--warning);
    color: white;
  }

  .action-link.primary:hover { opacity: 0.85; }

  /* ===== å£ã‚³ãƒŸQRã‚³ãƒ¼ãƒ‰ ===== */
  .qr-section {
    background: var(--white);
    border-radius: var(--radius);
    padding: 20px 24px 24px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
  }
  .qr-body {
    display: flex;
    align-items: flex-start;
    gap: 24px;
    flex-wrap: wrap;
  }
  .qr-canvas-wrap {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  #qr-container {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    background: #fff;
  }
  .qr-download-btn {
    background: var(--primary);
    color: #fff;
    border: none;
    padding: 9px 20px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
  }
  .qr-download-btn:hover { opacity: 0.85; }
  .qr-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding-top: 4px;
  }
  .qr-info-label {
    font-size: 12px;
    color: var(--gray-400);
    margin-bottom: 2px;
  }
  .qr-review-url {
    font-size: 13px;
    color: var(--primary);
    word-break: break-all;
    text-decoration: none;
  }
  .qr-review-url:hover { text-decoration: underline; }
  .qr-hint {
    font-size: 12px;
    color: var(--gray-500);
    line-height: 1.6;
    margin-top: 4px;
  }

  /* ===== ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ ===== */
  .trend-section {
    background: var(--white);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
  }

  .section-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .trend-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .trend-chart-wrap {
    background: var(--gray-50);
    border-radius: var(--radius-sm);
    padding: 12px;
  }

  .trend-chart-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-600);
    margin-bottom: 8px;
  }

  canvas { width: 100% !important; }

  /* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(44,74,114,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    color: white;
    gap: 16px;
  }

  .spinner {
    width: 44px;
    height: 44px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { font-size: 14px; font-weight: 500; }

  /* ===== infoå‹KPIã‚¢ã‚¤ãƒ†ãƒ  ===== */
  .kpi-item.info-item { background: var(--white); }
  .kpi-status.info { background: var(--gray-100); color: var(--gray-400); font-size: 12px; }
  .kpi-values .current.info { color: var(--primary); font-size: 16px; font-weight: 700; }

  /* ===== ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
  .advice-section {
    background: var(--white);
    border-radius: var(--radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .advice-header {
    background: linear-gradient(90deg, #2a3a6a, #4a65b0);
    color: white;
    padding: 14px 20px;
    font-size: 15px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .advice-body { padding: 16px 20px 20px; }

  .advice-intro {
    font-size: 12px;
    font-weight: 600;
    color: #4a65b0;
    margin: 0 0 14px;
    letter-spacing: 0.04em;
  }

  .advice-cards { display: flex; flex-direction: column; gap: 14px; }

  .advice-card {
    border: 1.5px solid #ccd9f0;
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .advice-card-head {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: linear-gradient(90deg, #f0f4fa, #e8eef8);
    flex-wrap: wrap;
  }

  .advice-card-num {
    width: 22px;
    height: 22px;
    background: #4a65b0;
    color: white;
    border-radius: 50%;
    font-size: 12px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .advice-card-title {
    font-size: 14px;
    font-weight: 700;
    color: #1e2d52;
    flex: 1;
  }

  .advice-card-pt {
    font-size: 11px;
    font-weight: 700;
    background: #dce8f5;
    color: #2d4a6e;
    padding: 2px 8px;
    border-radius: 999px;
    white-space: nowrap;
  }

  .advice-card-desc {
    font-size: 13px;
    line-height: 1.8;
    color: var(--gray-800);
    padding: 10px 14px 8px;
    margin: 0;
  }

  .advice-card-btns {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 0 14px 12px;
  }

  .advice-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    border: 1.5px solid #4a65b0;
    color: #4a65b0;
    background: white;
    transition: background 0.15s, color 0.15s;
  }
  .advice-action-btn:first-child {
    background: #4a65b0;
    color: white;
    border-color: #4a65b0;
  }
  .advice-action-btn:hover { opacity: 0.85; }

  .action-note, .advice-card-note {
    font-size: 11px;
    color: var(--gray-500);
    margin-top: 6px;
  }

  /* ===== åŠªåŠ›ç›®æ¨™ãƒãƒŠãƒ¼ ===== */
  .goal-banner {
    background: linear-gradient(135deg, #e8eef8, #f0f4fa);
    border: 1.5px solid #8aacce;
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    margin: 8px 0 4px;
    font-size: 13px;
    color: #1e2d52;
    line-height: 1.7;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }
  .goal-banner strong { color: #4a65b0; font-size: 15px; }

  /* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ===== */
  .qr-section .section-title {
    cursor: pointer;
    justify-content: space-between;
    user-select: none;
  }
  .qr-section .section-title::after { content: 'â–²'; font-size: 11px; opacity: 0.7; transition: transform 0.2s; }
  .qr-section.collapsed .section-title::after { transform: rotate(-180deg); }
  .qr-section.collapsed .qr-body { display: none; }

  .footer {
    text-align: center;
    font-size: 11px;
    color: #aaa;
    padding: 24px 16px 32px;
  }

  @media (max-width: 600px) {
    .summary-row { grid-template-columns: repeat(3,1fr); gap: 8px; }
    .summary-num { font-size: 22px; }
    .trend-grid { grid-template-columns: 1fr; }
    .login-card { padding: 32px 24px; }
    .top-bar {
      padding: 8px 12px;
      height: auto;
      flex-wrap: wrap;
      gap: 6px;
    }
    .top-bar-left { width: 100%; font-size: 13px; }
    .top-bar-right { width: 100%; justify-content: flex-end; }
    .contact-btn.mail span { display: none; }
    .contact-btn.line { padding: 7px 10px; }
  }
</style>
</head>
<body>

<!-- ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== -->
<div class="loading-overlay" id="loading" style="display:none;">
  <div class="spinner"></div>
  <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
</div>

<!-- ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹</div>
    <div class="login-title">é›†å®¢ãƒ•ã‚©ãƒ­ãƒ¼ãƒ„ãƒ¼ãƒ«</div>
    <div class="login-subtitle">æœ‰æ–™é™¢é™å®š</div>
    <label class="login-label">ã‚µãƒ­ãƒ³ID</label>
    <input type="text" id="salon-id-input" class="login-input" placeholder="ä¾‹ï¼š12345" />
    <label class="login-label" id="email-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
    <input type="email" id="email-input" class="login-input" placeholder="ä¾‹ï¼šinfo@example.com" />
    <button class="login-btn" onclick="handleLogin()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º</button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ===== -->
<div id="dashboard">
  <div class="top-bar">
    <div class="top-bar-left">é›†å®¢ãƒ•ã‚©ãƒ­ãƒ¼ãƒ„ãƒ¼ãƒ«</div>
    <div class="top-bar-right">
      <a href="#" target="_blank" class="contact-btn line">LINEç›¸è«‡</a>
      <a href="mailto:info@shinq-compass.jp" class="contact-btn mail">âœ‰ï¸ <span>ãƒ¡ãƒ¼ãƒ«ç›¸è«‡</span></a>
      <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <div class="main-content">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ -->
    <div class="header-card">
      <div class="salon-name" id="salon-name">â€•</div>
      <div class="data-date" id="data-date">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>
      <div class="rank-row">
        <div class="rank-badge" id="rank-badge" style="display:none;">
          <span>ã‚¨ãƒªã‚¢å†…é †ä½</span>
          <span class="rank-num" id="area-rank">â€•</span>
          <span>ä½</span>
        </div>
        <div class="search-point-badge" id="point-badge" style="display:none;">
          â­ æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆï¼š<strong id="search-point">â€•</strong> pt
        </div>
      </div>
    </div>

    <!-- åŠªåŠ›ç›®æ¨™ãƒãƒŠãƒ¼ -->
    <div class="goal-banner" id="goal-banner" style="display:none;">
      <span>ğŸ¯</span>
      <span id="goal-text"></span>
    </div>

    <!-- é”æˆã‚µãƒãƒªãƒ¼ -->
    <div class="summary-row">
      <div class="summary-card achieved">
        <div class="summary-num" id="achieved-count">â€•</div>
        <div class="summary-label">é”æˆä¸­</div>
      </div>
      <div class="summary-card unachieved">
        <div class="summary-num" id="unachieved-count">â€•</div>
        <div class="summary-label">æœªé”ãƒ»æœªè¨­å®š</div>
      </div>
      <div class="summary-card total">
        <div class="summary-num" id="total-count">â€•</div>
        <div class="summary-label">å–ã‚Šçµ„ã¿é …ç›®æ•°</div>
      </div>
    </div>

    <!-- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
    <div class="advice-section" id="advice-section" style="display:none;">
      <div class="advice-header">ğŸ’¡ ä»Šæœˆã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
      <div class="advice-body" id="advice-body"></div>
    </div>

    <!-- ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ• -->
    <div class="trend-section" id="trend-section" style="display:none;">
      <div class="section-title">ğŸ“ˆ æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆç›´è¿‘6ãƒ¶æœˆï¼‰</div>
      <div class="trend-grid">
        <div class="trend-chart-wrap">
          <div class="trend-chart-title">ã‚¢ã‚¯ã‚»ã‚¹æ•°</div>
          <canvas id="chart-access"></canvas>
        </div>
        <div class="trend-chart-wrap">
          <div class="trend-chart-title">ã‚¯ãƒªãƒƒã‚¯ç‡ï¼ˆ%ï¼‰</div>
          <canvas id="chart-ctr"></canvas>
        </div>
        <div class="trend-chart-wrap">
          <div class="trend-chart-title">ãƒãƒƒãƒˆäºˆç´„ç‡ï¼ˆ%ï¼‰</div>
          <canvas id="chart-cvr"></canvas>
        </div>
        <div class="trend-chart-wrap">
          <div class="trend-chart-title">å£ã‚³ãƒŸä»¶æ•°</div>
          <canvas id="chart-review"></canvas>
        </div>
      </div>
    </div>

    <!-- ãƒ‹ãƒ¼ã‚ºåˆ¥KPI -->
    <div id="kpi-sections"></div>

    <!-- å£ã‚³ãƒŸQRã‚³ãƒ¼ãƒ‰ -->
    <div class="qr-section" id="qr-section" style="display:none;">
      <div class="section-title">ğŸ“· å£ã‚³ãƒŸæŠ•ç¨¿ QRã‚³ãƒ¼ãƒ‰</div>
      <div class="qr-body">
        <div class="qr-canvas-wrap">
          <div id="qr-container"></div>
          <button class="qr-download-btn" onclick="downloadQR()">â¬‡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
        <div class="qr-info">
          <div class="qr-info-label">å£ã‚³ãƒŸæŠ•ç¨¿URL</div>
          <a id="qr-review-url" class="qr-review-url" href="" target="_blank" rel="noopener"></a>
          <p class="qr-hint">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã¨ã€ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹ã®å£ã‚³ãƒŸæŠ•ç¨¿ãƒšãƒ¼ã‚¸ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚é™¢å†…ã¸ã®æ²ç¤ºã‚„ãƒãƒ©ã‚·ã¸ã®å°åˆ·ã«ã”æ´»ç”¨ãã ã•ã„ã€‚</p>
        </div>
      </div>
    </div>

    <div class="footer">Copyright &copy; shinq-compass.jp All Rights Reserved.</div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
// ===== ãƒ­ã‚°è¨­å®š =====
const CS_INTERNAL_EMAIL = 'info@shinq-compass.jp'; // ã“ã®ãƒ¡ã‚¢ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³â†’ç¤¾å†…åˆ¤å®š
const GAS_LOG_URL = 'https://script.google.com/macros/s/AKfycbyUQ7zwgR4lT5eHddLBYnA2Oob55Z63kh4vlHZM7ZaPCEwfNu6oqqFwKsd5zJ4tYOWa/exec'; // â† log-sheet.gs ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦å–å¾—ã—ãŸURLã‚’è²¼ã‚Šä»˜ã‘
let isInternal = false; // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ç¤¾å†…/ç¤¾å¤–ã‚’åˆ¤å®šã—ã¦è¨­å®š
let loginTime = null;
let logSent = false;
const sessionClickedUrls = [];

// ===== è¨­å®šï¼ˆã“ã“ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰ =====
const API_KEY = 'AIzaSyAK_wtY_WFgOkw3L55BkWpmCQuzmhDpsIw'; // â† ç™ºè¡Œã—ãŸAPIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
const SPREADSHEET_ID = '1CiuXRdYG-lI_jWA4DiR_uXvYU9dgqTE1v-JWsZF1l_g';

// æœˆåˆ¥ã‚¿ãƒ–ï¼ˆæ–°ã—ã„é †ã«è¿½åŠ ã—ã¦ã„ãã€‚æ¯æœˆå…ˆé ­ã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰
const MONTHLY_SHEETS = ['2602', '2601', '2512'];
const FREE_TRIAL_SHEET = 'ç„¡æ–™ä½“é¨“';

// æ‹…å½“è€…é€£çµ¡å…ˆ
const LINE_URL = 'https://line.me/ti/p/@348cwzis';
const MAIL_ADDRESS = 'info@shinq-compass.jp';

// ===== KPIå®šç¾© =====
const KPI_DEFS = {
  // ãƒ‹ãƒ¼ã‚º1: æ¤œç´¢ã§è¦‹ã¤ã‘ã¦ã‚‚ã‚‰ã†
  search: {
    label: 'ğŸ” æ¤œç´¢ã§è¦‹ã¤ã‘ã¦ã‚‚ã‚‰ã†ãŸã‚ã«',
    theme: 'search',
    items: [
      { key: 'access', name: 'ã‚¢ã‚¯ã‚»ã‚¹æ•°', col: 12, threshold: 200, type: 'num', unit: '', searchPoint: false },
      { key: 'store_pr', name: 'åº—èˆ—PRæƒ…å ±ç™»éŒ²', col: 31, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 100 },
      { key: 'reserve_public', name: 'äºˆç´„å…¬é–‹åˆ©ç”¨é™¢', col: 27, threshold: 1, type: 'flag_str', unit: '', searchPoint: true, point: 50 },
      { key: 'reserve_gmb', name: 'äºˆç´„GMBè¨­ç½®', col: 28, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 50 },
      { key: 'reserve_banner', name: 'äºˆç´„ãƒãƒŠãƒ¼è¨­ç½®', col: 29, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 50 },
      { key: 'compass_link', name: 'ã‚³ãƒ³ãƒ‘ã‚¹ç›¸äº’ãƒªãƒ³ã‚¯è¨­ç½®', col: 30, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 30 },
    ]
  },
  // ãƒ‹ãƒ¼ã‚º2: äºˆç´„ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†
  click: {
    label: 'ğŸ‘† äºˆç´„ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†',
    theme: 'click',
    items: [
      { key: 'click', name: 'ã‚¯ãƒªãƒƒã‚¯æ•°', threshold: 20, type: 'num', unit: 'å›', searchPoint: false },
      { key: 'ctr', name: 'ã‚¯ãƒªãƒƒã‚¯ç‡', threshold: 10, type: 'rate', unit: '%', searchPoint: false, calc: (d) => d.access > 0 ? (d.click / d.access * 100) : null },
      { key: 'review', name: 'å£ã‚³ãƒŸä»¶æ•°', col: 23, threshold: 5, type: 'num', unit: 'ä»¶', searchPoint: true, point: '1ä»¶ã”ã¨' },
      { key: 'review_reply', name: 'å£ã‚³ãƒŸè¿”ä¿¡ä»¶æ•°', col: 24, threshold: 5, type: 'num', unit: 'ä»¶', searchPoint: true, point: '1ä»¶ã”ã¨' },
      { key: 'pickup_review', name: 'PickUpå£ã‚³ãƒŸ', col: 25, threshold: 1, type: 'flag', unit: '', searchPoint: false },
      { key: 'review_parts', name: 'å£ã‚³ãƒŸãƒ‘ãƒ¼ãƒ„è¨­ç½®', col: 26, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 30 },
      { key: 'menu3', name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼3ä»¶ä»¥ä¸Šç™»éŒ²', col: 32, threshold: 1, type: 'flag', unit: '', searchPoint: false },
    ]
  },
  // ãƒ‹ãƒ¼ã‚º3: å®Ÿéš›ã«äºˆç´„ã—ã¦ã‚‚ã‚‰ã†
  reserve: {
    label: 'ğŸ“… å®Ÿéš›ã«äºˆç´„ã—ã¦ã‚‚ã‚‰ã†',
    theme: 'reserve',
    items: [
      { key: 'net_reserve', name: 'äºˆç´„æ•°', threshold: 2, type: 'num', unit: 'ä»¶', searchPoint: false },
      { key: 'cvr', name: 'ãƒãƒƒãƒˆäºˆç´„ç‡', threshold: 10, type: 'rate', unit: '%', searchPoint: false, calc: (d) => d.click > 0 ? (d.net_reserve / d.click * 100) : null },
      { key: 'menu_link', name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼é€£æº', col: 33, threshold: 1, type: 'flag', unit: '', searchPoint: false },
      { key: 'guest_reserve', name: 'ã‚²ã‚¹ãƒˆäºˆç´„åˆ©ç”¨', col: 36, threshold: 1, type: 'flag', unit: '', searchPoint: false },
      { key: 'deadline', name: 'äºˆç´„å—ä»˜ç· åˆ‡æ™‚é–“', col: 37, threshold: 60, type: 'deadline', unit: 'åˆ†', searchPoint: false },
    ]
  }
};

// ===== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾© =====
const ACTIONS = {
  access: {
    text: 'ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¢—ã‚„ã™ãŸã‚ã«ã€ä»¥ä¸‹ã®æ–½ç­–ã‚’å®Ÿæ–½ã—ã¾ã—ã‚‡ã†ã€‚',
    links: [
      { label: 'ğŸ” æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆå¯¾è±¡KPIã‚’ç¢ºèªã™ã‚‹', action: 'scroll_search' },
      { label: 'ğŸ”— äºˆç´„å°ç·šç³»KPIã‚’ç¢ºèªã™ã‚‹', action: 'scroll_reserve' },
    ]
  },
  ctr: {
    text: 'ã‚¯ãƒªãƒƒã‚¯ç‡ã‚’ä¸Šã’ã‚‹ãŸã‚ã«ã€å£ã‚³ãƒŸã‚’å¼·åŒ–ã—ã¦æ‚£è€…ã•ã‚“ã®åå¿œã‚’é«˜ã‚ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'ğŸ’¬ å£ã‚³ãƒŸç³»KPIã‚’ç¢ºèªã™ã‚‹', action: 'scroll_click' }]
  },
  review: {
    text: 'å£ã‚³ãƒŸã‚’å¢—ã‚„ã™ãŸã‚ã«ã€ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ã‚’ã”æ´»ç”¨ãã ã•ã„ã€‚',
    note: 'â€» å£ã‚³ãƒŸä»£ç†æŠ•ç¨¿ç”¨ç´™ã¯å„é™¢7æšã¾ã§ï¼ˆé€šç®—ï¼‰ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚',
    links: [
      { label: 'ğŸ“„ å£ã‚³ãƒŸä»£ç†æŠ•ç¨¿ç”¨ç´™ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', url: 'https://shinq-compass-cs.github.io/kpi-tool/docs/kuchikomi.pdf' },
      { label: 'ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹', action: 'show_qr' },
      { label: 'ğŸ“‹ é™¢å†…è¨­ç½®ç”¨PDFï¼ˆ3æšï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', action: 'download_review_pdf' },
    ]
  },
  review_reply: {
    text: 'å£ã‚³ãƒŸã¸ã®è¿”ä¿¡ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚è¿”ä¿¡ã²ãªå½¢ç”Ÿæˆãƒ„ãƒ¼ãƒ«ã‚‚æ´»ç”¨ã§ãã¾ã™ã€‚',
    links: [
      { label: 'ğŸ’¬ å£ã‚³ãƒŸè¿”ä¿¡ãƒšãƒ¼ã‚¸ã¸', url: 'https://www.shinq-compass.jp/mypage/mypage_review/' },
      { label: 'âœï¸ è¿”ä¿¡ã²ãªå½¢ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹', url: 'https://example.com/reply-tool' },
    ]
  },
  pickup_review: {
    text: 'PickUpå£ã‚³ãƒŸã‚’è¨­å®šã—ã¦ã€æ‚£è€…ã•ã‚“ã®å°è±¡çš„ãªå£°ã‚’ç›®ç«‹ãŸã›ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ PickUpå£ã‚³ãƒŸã®è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://www.shinq-compass.jp/mypage/mypage_review/' }]
  },
  review_parts: {
    text: 'å£ã‚³ãƒŸãƒ‘ãƒ¼ãƒ„ã‚’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«è¨­ç½®ã—ã¦ã€æ‚£è€…ã•ã‚“ã«ä¿¡é ¼æ„Ÿã‚’ä¸ãˆã¾ã—ã‚‡ã†ã€‚',
    links: [
      { label: 'ğŸ› ï¸ ä»£è¡Œè¨­ç½®ã‚’ä¾é ¼ã™ã‚‹ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰', action: 'open_hp_form' },
      { label: 'ğŸ“‹ è‡ªåˆ†ã§è¨­ç½®ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰', url: 'https://www.shinq-compass.jp/mypage/mypage_widget/' },
    ]
  },
  store_pr: {
    text: 'åº—èˆ—PRæƒ…å ±ã‚’ç™»éŒ²ã—ã¦ã€æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼ˆ+100ptï¼‰ã€‚',
    links: [{ label: 'âš™ï¸ åº—èˆ—PRæƒ…å ±ã®è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://www.shinq-compass.jp/mypage/mypage_edit/' }]
  },
  menu3: {
    text: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’3ä»¶ä»¥ä¸Šç™»éŒ²ã—ã¦ã€æ‚£è€…ã•ã‚“ã«é¸ã°ã‚Œã‚„ã™ãã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ã®è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://www.shinq-compass.jp/mypage/yoyaku/setting/menu' }]
  },
  reserve_public: {
    text: 'ã—ã‚“ãã‚…ã†äºˆç´„ã‚’å…¬é–‹è¨­å®šã«ã—ã¦ã€ãƒãƒƒãƒˆäºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ã‚‡ã†ï¼ˆ+50ptï¼‰ã€‚',
    links: [{ label: 'âš™ï¸ äºˆç´„å…¬é–‹ã®è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://www.shinq-compass.jp/mypage/yoyaku/' }]
  },
  reserve_gmb: {
    text: 'Googleãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«ã—ã‚“ãã‚…ã†URLã‚’è¨­ç½®ã—ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ï¼ˆ+50ptï¼‰ã€‚',
    links: [
      { label: 'ğŸ› ï¸ ä»£è¡Œè¨­å®šã‚’ä¾é ¼ã™ã‚‹ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰', action: 'open_hp_form' },
      { label: 'ğŸ“‹ è‡ªåˆ†ã§è¨­å®šã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰', url: 'https://www.shinq-compass.jp/mypage/view/323' },
    ]
  },
  reserve_banner: {
    text: 'äºˆç´„ãƒãƒŠãƒ¼ã‚’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«è¨­ç½®ã—ã¦ã€äºˆç´„ã¸ã®å°ç·šã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†ï¼ˆ+50ptï¼‰ã€‚',
    links: [
      { label: 'ğŸ› ï¸ ä»£è¡Œè¨­ç½®ã‚’ä¾é ¼ã™ã‚‹ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰', action: 'open_hp_form' },
      { label: 'ğŸ“‹ è‡ªåˆ†ã§è¨­ç½®ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰', url: 'https://www.shinq-compass.jp/mypage/view/323' },
    ]
  },
  compass_link: {
    text: 'ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ã‚³ãƒ³ãƒ‘ã‚¹ã¸ã®ç›¸äº’ãƒªãƒ³ã‚¯ã‚’è¨­ç½®ã—ã¦ã€æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼ˆ+30ptï¼‰ã€‚',
    links: [
      { label: 'ğŸ› ï¸ ä»£è¡Œè¨­ç½®ã‚’ä¾é ¼ã™ã‚‹ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰', action: 'open_hp_form' },
      { label: 'ğŸ“‹ è‡ªåˆ†ã§è¨­ç½®ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰', url: 'https://www.shinq-compass.jp/info/link' },
    ]
  },
  menu_link: {
    text: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼é€£æºã‚’è¨­å®šã—ã¦ã€æ‚£è€…ã•ã‚“ãŒã‚¹ãƒ ãƒ¼ã‚ºã«äºˆç´„ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' }]
  },
  guest_reserve: {
    text: 'ã‚²ã‚¹ãƒˆäºˆç´„ã‚’æœ‰åŠ¹ã«ã—ã¦ã€åˆè¨ºã®æ‚£è€…ã•ã‚“ãŒäºˆç´„ã—ã‚„ã™ãã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ ã‚²ã‚¹ãƒˆäºˆç´„è¨­å®šã®ãƒšãƒ¼ã‚¸ã¸', url: 'https://www.shinq-compass.jp/mypage/yoyaku/setting/rule/' }]
  },
  deadline: {
    text: 'äºˆç´„å—ä»˜ç· åˆ‡ã‚’1æ™‚é–“ä»¥å†…ã«è¨­å®šã—ã¦ã€ç›´å‰ã®äºˆç´„ã‚’å–ã‚Šã“ã¼ã•ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' }]
  },
  cvr: {
    text: 'ãƒãƒƒãƒˆäºˆç´„ç‡ã‚’ä¸Šã’ã‚‹ãŸã‚ã«ã€äºˆç´„è¨­å®šç³»ã®KPIã‚’å®Ÿæ–½ã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'ğŸ“… äºˆç´„è¨­å®šç³»KPIã‚’ç¢ºèªã™ã‚‹', action: 'scroll_reserve' }]
  },
};

// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
let currentData = null;
let trendData = [];
let charts = {};
let avgData = null; // æœ‰æ–™é™¢å¹³å‡å€¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
function formatSheetName(name) {
  // 'YYMM' å½¢å¼ã®ã‚·ãƒ¼ãƒˆåã‚’ '20YYå¹´Mæœˆåˆ†' ã«å¤‰æ›
  if (/^\d{4}$/.test(name)) {
    const year = 2000 + parseInt(name.slice(0, 2));
    const month = parseInt(name.slice(2));
    return `${year}å¹´${month}æœˆåˆ†`;
  }
  return name;
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

function extractValue(cell) {
  if (cell === null || cell === undefined) return null;
  const str = String(cell);
  const match = str.match(/,"([^"]*?)"\)$/);
  if (match) return match[1];
  const match2 = str.match(/,([\d.]+)\)$/);
  if (match2) return parseFloat(match2[1]);
  return str;
}

async function fetchSheet(sheetName, range = 'A1:BZ1200') {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}!${range}?key=${API_KEY}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`ã‚·ãƒ¼ãƒˆå–å¾—å¤±æ•—: ${sheetName}`);
  const json = await res.json();
  return json.values || [];
}

// ===== ç„¡æ–™ä½“é¨“ã‚¿ãƒ–ã®æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ =====
// Fåˆ—ï¼ˆindex 5ï¼‰ã®æ—¥ä»˜ãŒå½“æœˆ1æ—¥ä»¥é™ã®è¡Œã®ã¿æœ‰åŠ¹ã¨ã™ã‚‹
function isFreeTrialDateValid(row) {
  const dateVal = row[5]; // Fåˆ—å›ºå®š
  if (!dateVal) return false;
  let dateStr = String(dateVal).trim();
  // YY/MM/DD å½¢å¼ï¼ˆ2æ¡å¹´ï¼‰ã‚’ YYYY/MM/DD ã«å¤‰æ›ï¼ˆä¾‹: 26/04/19 â†’ 2026/04/19ï¼‰
  const m = dateStr.match(/^(\d{2})\/(\d{2})\/(\d{2})$/);
  if (m) dateStr = `20${m[1]}/${m[2]}/${m[3]}`;
  const date = new Date(dateStr.replace(/\//g, '-'));
  if (isNaN(date.getTime())) return false;
  // 2020å¹´ä»¥å‰ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦ç„¡æ¡ä»¶è¡¨ç¤º
  if (date.getFullYear() < 2020) return true;
  const now = new Date();
  const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  return date >= firstOfMonth;
}

// ===== ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è‡ªå‹•æ¤œå‡ºï¼ˆå…ˆé ­ã‹ã‚‰æœ€å¤§5è¡Œã‚’èµ°æŸ»ã—ã¦ã€Œã‚µãƒ­ãƒ³IDã€ã‚’å«ã‚€è¡Œã‚’æ¢ã™ï¼‰ =====
function findHeaderRowIndex(rows) {
  for (let i = 0; i < Math.min(rows.length, 5); i++) {
    if (rows[i] && rows[i].some(cell => String(cell || '').trim() === 'ã‚µãƒ­ãƒ³ID')) {
      return i;
    }
  }
  return 0; // è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°å…ˆé ­è¡Œã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
}

// ===== ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒãƒ—æ§‹ç¯‰ï¼ˆæ”¹è¡Œã‚’é™¤å»ã—ã¦æ­£è¦åŒ–ï¼‰ =====
function buildHeaderMap(headerRow) {
  const map = {};
  if (!headerRow) return map;
  for (let i = 0; i < headerRow.length; i++) {
    // ã‚»ãƒ«å†…ã®æ”¹è¡Œã‚’é™¤å»ã—ã¦ã‚­ãƒ¼ã‚’æ­£è¦åŒ–ï¼ˆåˆå‡ºã‚’å„ªå…ˆï¼‰
    const h = String(headerRow[i] || '').replace(/\n/g, '').trim();
    if (h && !(h in map)) map[h] = i;
  }
  return map;
}

// ===== è¡Œãƒ‡ãƒ¼ã‚¿ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒãƒ—ã§è§£æï¼ˆVLOOKUPæ–¹å¼ï¼‰ =====
function parseRowDynamic(row, hm) {
  const getVal = (idx) => {
    if (idx === undefined) return null;
    const val = row[idx];
    if (val === undefined || val === null || val === '' || val === '#N/A') return null;
    const num = parseFloat(val);
    return isNaN(num) ? val : num;
  };

  // è¤‡æ•°å€™è£œã‚­ãƒ¼ã§æ¤œç´¢ï¼šå®Œå…¨ä¸€è‡´ â†’ å‰æ–¹ä¸€è‡´ï¼ˆã€Œã‚¢ã‚¯ã‚»ã‚¹æ•°ã€â†’ã€Œã‚¢ã‚¯ã‚»ã‚¹æ•°ï¼ˆ30æ—¥ï¼‰ã€ï¼‰â†’ æ¬¡å€™è£œ
  const findIdx = (...keys) => {
    for (const key of keys) {
      if (hm[key] !== undefined) return hm[key];
      const found = Object.keys(hm).find(k => k.startsWith(key) && k !== key);
      if (found !== undefined) return hm[found];
    }
    return undefined;
  };
  const get = (...keys) => getVal(findIdx(...keys));

  const emailIdx = findIdx('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹');
  return {
    salon_id:          String(getVal(findIdx('ã‚µãƒ­ãƒ³ID')) || '').trim(),
    name:              get('é™¢å'),
    email:             emailIdx !== undefined ? String(row[emailIdx] || '').trim().toLowerCase() : '',
    login:             get('ãƒ­ã‚°ã‚¤ãƒ³'),
    // ã‚·ãƒ¼ãƒˆã«ã‚ˆã‚Šåˆ—åãŒç•°ãªã‚‹é …ç›®ã¯è¤‡æ•°å€™è£œã‚’æŒ‡å®š
    compass_plan:      get('ã‚³ãƒ³ãƒ‘ã‚¹ç¾åœ¨ãƒ—ãƒ©ãƒ³', 'ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹ï¼šãƒ—ãƒ©ãƒ³'),
    yoyaku_plan:       get('äºˆç´„ç¾åœ¨ãƒ—ãƒ©ãƒ³', 'ã—ã‚“ãã‚…ã†äºˆç´„ï¼šç¾åœ¨ã®ãƒ—ãƒ©ãƒ³'),
    area:              get('æ¤œç´¢é †ä½ã‚¨ãƒªã‚¢'),
    area_rank:         get('ã‚¨ãƒªã‚¢å†…ãƒ©ãƒ³ã‚­ãƒ³ã‚°'),
    search_point:      get('æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ', 'æ²è¼‰å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ'),   // 2602ã¯ã€Œæ²è¼‰å„ªå…ˆãƒã‚¤ãƒ³ãƒˆã€
    access:            get('ã‚¢ã‚¯ã‚»ã‚¹æ•°'),                            // å‰æ–¹ä¸€è‡´ã§ã€Œã‚¢ã‚¯ã‚»ã‚¹æ•°ï¼ˆ30æ—¥ï¼‰ã€ã«ã‚‚å¯¾å¿œ
    click:             get('ã‚¯ãƒªãƒƒã‚¯æ•°', 'äºˆç´„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ•°'),      // 2601ã¯ã€Œäºˆç´„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ•°ã€
    net_reserve:       get('ãƒãƒƒãƒˆäºˆç´„æ•°'),
    reserve_public:    get('äºˆç´„å…¬é–‹çŠ¶æ…‹', 'äºˆç´„å…¬é–‹åˆ©ç”¨é™¢'),          // 2601ã¯ã€Œäºˆç´„å…¬é–‹åˆ©ç”¨é™¢ã€
    reserve_gmb:       get('äºˆç´„GMB'),
    reserve_banner:    get('äºˆç´„ãƒãƒŠãƒ¼'),                            // å‰æ–¹ä¸€è‡´ã§ã€Œäºˆç´„ãƒãƒŠãƒ¼è¨­ç½®18800ã€ã‚‚å¯¾å¿œ
    compass_link:      get('HPç›¸äº’ãƒªãƒ³ã‚¯', 'ã‚³ãƒ³ãƒ‘ã‚¹ç›¸äº’ãƒªãƒ³ã‚¯è¨­ç½®'),  // 2601ã¯ã€Œã‚³ãƒ³ãƒ‘ã‚¹ç›¸äº’ãƒªãƒ³ã‚¯è¨­ç½®ã€
    review_parts:      get('å£ã‚³ãƒŸãƒ‘ãƒ¼ãƒ„'),                          // å‰æ–¹ä¸€è‡´ã§ã€Œå£ã‚³ãƒŸãƒ‘ãƒ¼ãƒ„è¨­ç½®ã€ã€Œå£ã‚³ãƒŸãƒ‘ãƒ¼ãƒ„(30ç‚¹)ã€ã‚‚å¯¾å¿œ
    pickup_review:     get('å£ã‚³ãƒŸpickup', 'PickUpå£ã‚³ãƒŸ'),           // 2601ã¯ã€ŒPickUpå£ã‚³ãƒŸã€
    store_pr:          get('åº—èˆ—PRæƒ…å ±ç™»éŒ²'),
    menu3:             get('ãƒ¡ãƒ‹ãƒ¥ãƒ¼3ä»¶ä»¥ä¸Šç™»éŒ²'),
    menu_link:         get('ãƒ¡ãƒ‹ãƒ¥ãƒ¼é€£æº'),
    guest_reserve:     get('ã‚²ã‚¹ãƒˆäºˆç´„åˆ©ç”¨'),
    deadline:          get('äºˆç´„å—ä»˜ç· åˆ‡æ™‚é–“'),
    calendar_count:    get('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ä»¶æ•°'),
    net_reserve_count: get('ãƒãƒƒãƒˆäºˆç´„ä»¶æ•°', 'ãƒãƒƒãƒˆäºˆç´„'),            // 2601ã¯ã€Œãƒãƒƒãƒˆäºˆç´„ã€
    manual_count:      get('æ‰‹å‹•ç™»éŒ²ä»¶æ•°', 'æ‰‹å‹•ç™»éŒ²'),               // 2601ã¯ã€Œæ‰‹å‹•ç™»éŒ²ã€
    block_count:       get('ãƒ–ãƒ­ãƒƒã‚¯ä»¶æ•°', 'ãƒ–ãƒ­ãƒƒã‚¯'),               // 2601ã¯ã€Œãƒ–ãƒ­ãƒƒã‚¯ã€
    review:            get('å£ã‚³ãƒŸä»¶æ•°', 'å£ã‚³ãƒŸ5ä»¶ä»¥ä¸Š'),            // å®Ÿæ…‹ã¯ä»¶æ•°å€¤ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹
    review_reply:      get('å£ã‚³ãƒŸè¿”ä¿¡æ•°', 'å£ã‚³ãƒŸè¿”ä¿¡ï¼•ä»¶ä»¥ä¸Š'),
  };
}

// ===== ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† =====
async function handleLogin() {
  const salonId = document.getElementById('salon-id-input').value.trim();
  const email = document.getElementById('email-input').value.trim().toLowerCase();
  if (!salonId || !email) {
    const err = document.getElementById('login-error');
    err.textContent = 'ã‚µãƒ­ãƒ³IDã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    err.style.display = 'block';
    return;
  }
  // ç¤¾å†…åˆ¤å®šï¼šCSå°‚ç”¨ãƒ¡ã‚¢ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã¯ãƒ¡ãƒ¼ãƒ«ç…§åˆã‚’ã‚¹ã‚­ãƒƒãƒ—
  const loginIsInternal = (email === CS_INTERNAL_EMAIL);

  showLoading(true);
  document.getElementById('login-error').style.display = 'none';

  try {
    let found = null;
    let foundSheet = null;
    trendData = [];

    // æœˆåˆ¥ã‚¿ãƒ–ã‚’æ–°ã—ã„é †ã«æ¤œç´¢ï¼ˆå…¨æœˆåˆ†ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚‚åé›†ï¼‰
    let firstSheetRows = null, firstSheetHm = null;
    for (const sheet of MONTHLY_SHEETS) {
      const rows = await fetchSheet(sheet);
      if (!rows.length) continue;
      const headerIdx = findHeaderRowIndex(rows);          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è‡ªå‹•æ¤œå‡º
      const hm = buildHeaderMap(rows[headerIdx]);
      // æœ€æ–°ã‚·ãƒ¼ãƒˆï¼ˆå…ˆé ­ï¼‰ã®å…¨è¡Œãƒ‡ãƒ¼ã‚¿ã‚’å¹³å‡å€¤è¨ˆç®—ç”¨ã«ä¿æŒ
      if (!firstSheetRows) { firstSheetRows = rows; firstSheetHm = hm; }
      const idCol = hm['ã‚µãƒ­ãƒ³ID'] ?? 0;
      for (let i = headerIdx + 1; i < rows.length; i++) { // ãƒ‡ãƒ¼ã‚¿è¡Œã¯ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ¬¡ã‹ã‚‰
        const id = String(rows[i][idCol] || '').trim();
        if (id === salonId) {
          const data = parseRowDynamic(rows[i], hm);
          // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸï¼ˆæœ€æ–°ï¼‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨
          if (!found) {
            found = data;
            foundSheet = sheet;
            // åˆ°é”å¯èƒ½ãƒã‚¤ãƒ³ãƒˆãƒ»é †ä½ã‚’è¨ˆç®—ã—ã¦ãƒ‡ãƒ¼ã‚¿ã«ä»˜åŠ 
            const addPt = calcAdditionalPoints(found);
            const maxPt = Number(found.search_point || 0) + addPt;
            found.add_pt = addPt;
            found.potential_max_pt = maxPt;
            found.potential_rank = calcPotentialRank(found.area, maxPt, rows, hm);
          }
          // å…¨æœˆåˆ†ã‚’ãƒˆãƒ¬ãƒ³ãƒ‰ç”¨ã«åé›†ï¼ˆå¤ã„é †ã«ãªã‚‹ã‚ˆã†unshiftã§å…ˆé ­è¿½åŠ ï¼‰
          trendData.unshift({ sheet, data });
          break;
        }
      }
    }

    // æœ€æ–°æœˆåˆ¥ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ‰æ–™é™¢ã®å¹³å‡å€¤ã‚’è¨ˆç®—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ãªã‚‰å†è¨ˆç®—ã—ãªã„ï¼‰
    if (!avgData && firstSheetRows && firstSheetHm) {
      avgData = calcSheetAverages(firstSheetRows, firstSheetHm);
    }

    // æœˆåˆ¥ã«è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ç„¡æ–™ä½“é¨“ã‚¿ãƒ–ã‚’æ¤œç´¢
    if (!found) {
      const rows = await fetchSheet(FREE_TRIAL_SHEET);
      if (rows.length) {
        const headerIdx = findHeaderRowIndex(rows);          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è‡ªå‹•æ¤œå‡º
        const hm = buildHeaderMap(rows[headerIdx]);
        const idCol = hm['ã‚µãƒ­ãƒ³ID'] ?? 0;
        for (let i = headerIdx + 1; i < rows.length; i++) { // ãƒ‡ãƒ¼ã‚¿è¡Œã¯ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ¬¡ã‹ã‚‰
          const row = rows[i];
          const id = String(row[idCol] || '').trim();
          if (id === salonId) {
            // Fåˆ—ï¼ˆindex 5ï¼‰ãŒå…ˆæœˆä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã¯é™¤å¤–ï¼ˆYY/MM/DDå½¢å¼ãƒ»ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚‚è€ƒæ…®ï¼‰
            if (!isFreeTrialDateValid(row)) break;
            found = parseRowDynamic(row, hm);
            foundSheet = FREE_TRIAL_SHEET;
            // åˆ°é”å¯èƒ½ãƒã‚¤ãƒ³ãƒˆãƒ»é †ä½ã‚’è¨ˆç®—ã—ã¦ãƒ‡ãƒ¼ã‚¿ã«ä»˜åŠ 
            const addPt = calcAdditionalPoints(found);
            const maxPt = Number(found.search_point || 0) + addPt;
            found.add_pt = addPt;
            found.potential_max_pt = maxPt;
            found.potential_rank = calcPotentialRank(found.area, maxPt, rows, hm);
            break;
          }
        }
      }
    }

    if (!found) {
      const err = document.getElementById('login-error');
      err.textContent = 'ã‚µãƒ­ãƒ³IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç•ªå·ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
      err.style.display = 'block';
      showLoading(false);
      return;
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç…§åˆï¼ˆç¤¾å†…ãƒ¡ã‚¢ãƒ‰ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    if (!loginIsInternal && found.email !== email) {
      const err = document.getElementById('login-error');
      err.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚ã”ç¢ºèªãã ã•ã„ã€‚';
      err.style.display = 'block';
      showLoading(false);
      return;
    }

    currentData = found;
    isInternal = loginIsInternal;
    if (!isInternal) {
      loginTime = new Date();
      logSent = false;
      sessionClickedUrls.length = 0;
    }
    renderDashboard(found, foundSheet);

  } catch (e) {
    console.error(e);
    document.getElementById('login-error').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
    document.getElementById('login-error').style.display = 'block';
  }

  showLoading(false);
}

// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”» =====
function renderDashboard(d, sheetName) {
  // é™¢åãƒ»æ—¥ä»˜
  document.getElementById('salon-name').textContent = d.name || `ã‚µãƒ­ãƒ³ID: ${d.salon_id}`;
  // ãƒ‡ãƒ¼ã‚¿å‚ç…§å…ƒ ï½œ è¡¨ç¤ºæ—¥æ™‚ ï½œ å¥‘ç´„ãƒ—ãƒ©ãƒ³ã‚’1è¡Œã§è¡¨ç¤º
  let dateStr = `ãƒ‡ãƒ¼ã‚¿å‚ç…§å…ƒï¼š${formatSheetName(sheetName)} ï½œ è¡¨ç¤ºæ—¥æ™‚ï¼š${new Date().toLocaleDateString('ja-JP', {year:'numeric',month:'long',day:'numeric'})}`;
  if (d.compass_plan) {
    dateStr += ` ï½œ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹ï¼š${d.compass_plan}`;
    const isPlatinaPlus = String(d.compass_plan).trim() === 'ãƒ—ãƒ©ãƒãƒŠPLUSãƒ—ãƒ©ãƒ³' || String(d.compass_plan).trim() === 'ãƒ—ãƒ©ãƒãƒŠPLUS';
    const yoyakuText = isPlatinaPlus ? 'ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ç›¸å½“' : (d.yoyaku_plan || '');
    if (yoyakuText) dateStr += ` ï½œ ã—ã‚“ãã‚…ã†äºˆç´„ï¼š${yoyakuText}`;
  }
  document.getElementById('data-date').textContent = dateStr;

  // ã‚¨ãƒªã‚¢å†…ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  if (d.area_rank !== null && d.area_rank !== undefined) {
    document.getElementById('area-rank').textContent = d.area_rank;
    document.getElementById('rank-badge').style.display = 'flex';
  }

  // æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ
  if (d.search_point !== null) {
    document.getElementById('search-point').textContent = d.search_point;
    document.getElementById('point-badge').style.display = 'flex';

    // åŠªåŠ›ç›®æ¨™ãƒãƒŠãƒ¼ï¼ˆåŒã‚¨ãƒªã‚¢ä»–é™¢ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆ°é”å¯èƒ½é †ä½ã‚’è¡¨ç¤ºï¼‰
    if (d.add_pt > 0 && d.potential_rank !== undefined) {
      document.getElementById('goal-text').innerHTML =
        `æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ <strong>${d.potential_max_pt}pt</strong> ã«ã™ã‚Œã°ã€æœ€å¤§ã‚¨ãƒªã‚¢å†…é †ä½ <strong>${d.potential_rank}ä½</strong> ã¾ã§å¯èƒ½ï¼ˆã‚ã¨ <strong>+${d.add_pt}pt</strong> ç²å¾—å¯èƒ½ï¼‰`;
      document.getElementById('goal-banner').style.display = 'flex';
    }
  }

  // KPIã‚»ã‚¯ã‚·ãƒ§ãƒ³æç”»
  let totalAchieved = 0, totalUnachieved = 0, totalCount = 0;

  const sectionsEl = document.getElementById('kpi-sections');
  sectionsEl.innerHTML = '';

  Object.entries(KPI_DEFS).forEach(([needsKey, needsDef]) => {
    const section = document.createElement('div');
    section.className = 'needs-section';
    section.id = `needs-${needsKey}`;

    const header = document.createElement('div');
    header.className = `needs-header ${needsDef.theme}`;
    header.innerHTML = `<span class="needs-header-label"><span class="needs-emoji"></span><span>${needsDef.label}</span></span><span class="needs-chevron">â–¼</span>`;
    header.addEventListener('click', () => section.classList.toggle('collapsed'));
    section.appendChild(header);

    const body = document.createElement('div');
    body.className = 'needs-body';

    needsDef.items.forEach(item => {
      let value = null;
      let achieved = false;
      const isInfo = item.type === 'info';

      if (item.type === 'rate' && item.calc) {
        value = item.calc(d);
        if (value !== null) achieved = value >= item.threshold;
      } else if (item.type === 'num') {
        value = d[item.key];
        if (value !== null) achieved = value >= item.threshold;
      } else if (item.type === 'flag') {
        value = d[item.key];
        achieved = value == 1;
      } else if (item.type === 'flag_str') {
        value = d[item.key];
        achieved = value == 1 || value === 'å…¬é–‹';
      } else if (item.type === 'deadline') {
        value = d[item.key];
        if (value !== null) achieved = value <= item.threshold;
      } else if (isInfo) {
        value = d[item.key];
      }

      // infoå‹ã¯é”æˆã‚«ã‚¦ãƒ³ãƒˆã«å«ã‚ãªã„
      if (!isInfo) {
        totalCount++;
        if (achieved) totalAchieved++;
        else totalUnachieved++;
      }

      const itemEl = document.createElement('div');
      itemEl.className = isInfo ? 'kpi-item info-item' : `kpi-item ${achieved ? 'achieved' : 'unachieved'}`;

      // å€¤ã®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ
      let valueText = '';
      if (item.type === 'rate') {
        valueText = value !== null ? `${value.toFixed(1)}% / ç›®æ¨™ ${item.threshold}%` : 'â€•';
      } else if (item.type === 'num') {
        valueText = value !== null ? `${value}${item.unit} / ç›®æ¨™ ${item.threshold}${item.unit}` : 'â€•';
      } else if (item.type === 'flag' || item.type === 'flag_str') {
        valueText = achieved ? 'è¨­å®šæ¸ˆã¿ âœ“' : 'æœªè¨­å®š';
      } else if (item.type === 'deadline') {
        valueText = value !== null ? `${value}åˆ† / ç›®æ¨™ ${item.threshold}åˆ†ä»¥å†…` : 'â€•';
      } else if (isInfo) {
        valueText = value !== null ? `${value}${item.unit}` : 'â€•';
      }

      const pointBadge = item.searchPoint
        ? `<span class="kpi-point-badge">â˜… ${item.point ? item.point + 'pt' : 'ãƒã‚¤ãƒ³ãƒˆå¯¾è±¡'}</span>`
        : '';

      const statusIcon = isInfo ? 'â€•' : (achieved ? 'âœ“' : '!');
      const statusClass = isInfo ? 'info' : (achieved ? 'ok' : 'ng');

      itemEl.innerHTML = `
        <div class="kpi-status ${statusClass}">${statusIcon}</div>
        <div class="kpi-main">
          <div class="kpi-name-row">
            <span class="kpi-name">${item.name}</span>
            ${pointBadge}
          </div>
          <div class="kpi-values">
            <span class="current ${statusClass}">${valueText}</span>
          </div>
          ${!isInfo && !achieved && ACTIONS[item.key] ? renderAction(item.key) : ''}
        </div>
      `;

      body.appendChild(itemEl);
    });

    section.appendChild(body);
    if (window.innerWidth <= 600) section.classList.add('collapsed');
    sectionsEl.appendChild(section);
  });

  // ã‚µãƒãƒªãƒ¼æ›´æ–°
  document.getElementById('achieved-count').textContent = totalAchieved;
  document.getElementById('unachieved-count').textContent = totalUnachieved;
  document.getElementById('total-count').textContent = totalCount;

  // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•
  if (trendData.length >= 2) {
    renderTrendCharts();
  }

  // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  // ã‚¢ãƒ‰ãƒã‚¤ã‚¹æç”»
  renderAdvice(d);

  // å£ã‚³ãƒŸQRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆqrcodejs ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨ï¼‰
  const reviewUrl = `https://www.shinq-compass.jp/salon/review/add/${d.salon_id}`;
  const urlEl = document.getElementById('qr-review-url');
  urlEl.href = reviewUrl;
  urlEl.textContent = reviewUrl;
  const container = document.getElementById('qr-container');
  container.innerHTML = '';           // å‰å›ã®QRã‚’ã‚¯ãƒªã‚¢
  container.dataset.salonId = d.salon_id;
  new QRCode(container, {
    text: reviewUrl,
    width: 200,
    height: 200,
    colorDark: '#1a1a1a',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M,
  });
  const qrSection = document.getElementById('qr-section');
  qrSection.style.display = 'block';
  if (window.innerWidth <= 600) qrSection.classList.add('collapsed');
  qrSection.querySelector('.section-title').addEventListener('click', () => qrSection.classList.toggle('collapsed'));

  // ãƒ©ã‚¤ãƒ³å•ã„åˆã‚ã›URLæ›´æ–°
  document.querySelector('.contact-btn.line').href = LINE_URL;
}

// ===== QRã‚³ãƒ¼ãƒ‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
function downloadQR() {
  const container = document.getElementById('qr-container');
  const salonId = container.dataset.salonId || 'salon';
  // qrcodejs ã¯ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ canvas ã‚’ç”Ÿæˆã™ã‚‹
  const canvas = container.querySelector('canvas');
  if (!canvas) return;
  const link = document.createElement('a');
  link.download = `kuchikomi-qr-${salonId}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

function renderAction(key) {
  const action = ACTIONS[key];
  if (!action) return '';

  const links = action.links.map(link => {
    if (link.url) {
      return `<a href="${link.url}" target="_blank" class="action-link primary">${link.label}</a>`;
    }
    return `<button class="action-link" onclick="handleActionClick('${link.action}')">${link.label}</button>`;
  }).join('');

  const noteHtml = action.note ? `<div class="action-note">${action.note}</div>` : '';
  return `
    <div class="action-box">
      <div class="action-title">âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
      <div>${action.text}</div>
      <div class="action-links">${links}</div>
      ${noteHtml}
    </div>
  `;
}

function handleActionClick(action) {
  if (action === 'scroll_search') document.getElementById('needs-search')?.scrollIntoView({ behavior: 'smooth' });
  if (action === 'scroll_click') document.getElementById('needs-click')?.scrollIntoView({ behavior: 'smooth' });
  if (action === 'scroll_reserve') document.getElementById('needs-reserve')?.scrollIntoView({ behavior: 'smooth' });
  if (action === 'show_qr') document.getElementById('qr-section')?.scrollIntoView({ behavior: 'smooth' });
  if (action === 'download_review_pdf') downloadReviewPdf();
  if (action === 'open_hp_form') openHpForm();
}

function openHpForm() {
  if (!currentData) return;
  const hashId   = '1FAIpQLSfzJ9bcUTeSO35VK3t-iyG_2UTZWCGJ84q0Ake2l_c7LNWmtQ';
  const idEntry  = '414957000';
  const nameEntry= '941398320';
  const url = `https://docs.google.com/forms/d/e/${hashId}/viewform?usp=pp_url` +
    `&entry.${idEntry}=${encodeURIComponent(currentData.salon_id || '')}` +
    `&entry.${nameEntry}=${encodeURIComponent(currentData.name || '')}`;
  trackUrl(url);
  window.open(url, '_blank');
}

async function downloadReviewPdf() {
  if (!currentData) return;
  const salonId = currentData.salon_id;
  const reviewUrl = `https://www.shinq-compass.jp/salon/review/add/${salonId}`;

  // QRã‚³ãƒ¼ãƒ‰ã‚’éè¡¨ç¤ºdivã«ç”Ÿæˆã—ã¦canvasãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const tempDiv = document.createElement('div');
  tempDiv.style.cssText = 'position:fixed;left:-9999px;top:-9999px;';
  document.body.appendChild(tempDiv);
  new QRCode(tempDiv, {
    text: reviewUrl,
    width: 200, height: 200,
    colorDark: '#1a1a1a', colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M,
  });
  const qrCanvas = tempDiv.querySelector('canvas');
  const qrDataUrl = qrCanvas.toDataURL('image/png');
  document.body.removeChild(tempDiv);

  // pdf-lib ã§ãƒ™ãƒ¼ã‚¹PDFã‚’èª­ã¿è¾¼ã¿
  if (!window.PDFLib) { alert('PDFç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'); return; }
  const { PDFDocument } = window.PDFLib;
  const pdfUrl = 'https://shinq-compass-cs.github.io/kpi-tool/docs/post%20a%20review.pdf';
  let pdfBytes;
  try {
    pdfBytes = await fetch(pdfUrl).then(r => { if (!r.ok) throw new Error(r.status); return r.arrayBuffer(); });
  } catch (e) {
    alert('PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    return;
  }
  const pdfDoc = await PDFDocument.load(pdfBytes);
  const pages = pdfDoc.getPages();
  if (pages.length < 2) { alert('PDFãƒšãƒ¼ã‚¸æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™'); return; }

  // 2ãƒšãƒ¼ã‚¸ç›®å³ä¸‹ã®ç©ºæ¬„ã«QRã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã‚€
  const page2 = pages[1];
  const { width, height } = page2.getSize();
  const qrImageBytes = await fetch(qrDataUrl).then(r => r.arrayBuffer());
  const qrImage = await pdfDoc.embedPng(qrImageBytes);

  // 2ãƒšãƒ¼ã‚¸ç›®å³ä¸‹ã®ç©ºæ¬„æ ï¼ˆx:570-710, y:80-220ï¼‰ã®ä¸­å¤®ã«é…ç½®
  const qrSize = 120;  // æ 140ptã«å¯¾ã—ã¦ä¸Šä¸‹å·¦å³10ptã®ä½™ç™½
  page2.drawImage(qrImage, {
    x: 580,
    y: 90,
    width: qrSize,
    height: qrSize,
  });

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  const modifiedBytes = await pdfDoc.save();
  const blob = new Blob([modifiedBytes], { type: 'application/pdf' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `é™¢å†…è¨­ç½®ç”¨QR_${salonId}.pdf`;
  link.click();
  URL.revokeObjectURL(link.href);
}

// ===== è¿½åŠ å–å¾—å¯èƒ½ãƒã‚¤ãƒ³ãƒˆè¨ˆç®— =====
function calcAdditionalPoints(d) {
  const items = [
    { key: 'store_pr',      point: 100, type: 'flag' },
    { key: 'reserve_public', point: 50, type: 'flag_str' },
    { key: 'reserve_gmb',   point: 50,  type: 'flag' },
    { key: 'reserve_banner', point: 50, type: 'flag' },
    { key: 'compass_link',  point: 30,  type: 'flag' },
    { key: 'review_parts',  point: 30,  type: 'flag' },
  ];
  let add = 0;
  for (const item of items) {
    const val = d[item.key];
    const achieved = item.type === 'flag'
      ? (Number(val) >= 1)
      : (val == 1 || val === 'å…¬é–‹');
    if (!achieved) add += item.point;
  }
  return add;
}

// ===== åŒã‚¨ãƒªã‚¢å†…ã§ã®åˆ°é”å¯èƒ½é †ä½ã‚’è¨ˆç®— =====
// maxPt ã‚’é”æˆã—ãŸå ´åˆã«ä½•ä½ã«ãªã‚‹ã‹ã‚’å…¨è¡Œãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç®—å‡ºï¼ˆVLOOKUPæ–¹å¼ï¼‰
// ===== æœ‰æ–™é™¢å¹³å‡å€¤è¨ˆç®—ï¼ˆæœ€æ–°æœˆåˆ¥ã‚·ãƒ¼ãƒˆå…¨è¡Œï¼‰ =====
function calcSheetAverages(allRows, hm) {
  const hi = findHeaderRowIndex(allRows);
  const acc = [], ctr = [], cvr = [], rev = [];
  for (let i = hi + 1; i < allRows.length; i++) {
    const d = parseRowDynamic(allRows[i], hm);
    if (d.access > 0)  acc.push(d.access);
    if (d.access > 0 && d.click != null)  ctr.push(d.click / d.access * 100);
    if (d.click > 0 && d.net_reserve != null) cvr.push(d.net_reserve / d.click * 100);
    if (d.review != null && d.review >= 0)  rev.push(d.review);
  }
  const avg = arr => arr.length ? parseFloat((arr.reduce((s,v)=>s+v,0)/arr.length).toFixed(1)) : null;
  return { access: avg(acc), ctr: avg(ctr), cvr: avg(cvr), review: avg(rev) };
}

function calcPotentialRank(area, maxPt, allRows, hm) {
  const areaIdx = hm['æ¤œç´¢é †ä½ã‚¨ãƒªã‚¢'];
  // ã‚·ãƒ¼ãƒˆã«ã‚ˆã‚Šåˆ—åãŒç•°ãªã‚‹ï¼ˆ2602: æ²è¼‰å„ªå…ˆãƒã‚¤ãƒ³ãƒˆã€2601ä»¥å‰: æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆï¼‰
  const ptIdx   = hm['æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ'] ?? hm['æ²è¼‰å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ'];
  if (areaIdx === undefined || ptIdx === undefined) return null;
  const startRow = findHeaderRowIndex(allRows) + 1; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
  let countAbove = 0;
  for (let i = startRow; i < allRows.length; i++) {
    const rowArea = String(allRows[i][areaIdx] || '').trim();
    const rowPt   = parseFloat(allRows[i][ptIdx]);
    if (rowArea === String(area || '').trim() && !isNaN(rowPt) && rowPt > maxPt) {
      countAbove++;
    }
  }
  return countAbove + 1;
}

// ===== ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”¨ãƒªãƒƒãƒå®šç¾© =====
const ADVICE_RICH = {
  store_pr: {
    icon: 'ğŸª', title: 'åº—èˆ—PRæƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹', pt: '+100pt',
    desc: 'æ¤œç´¢çµæœã«é™¢ã®ç‰¹é•·ãƒ»å¼·ã¿ã‚’æ²è¼‰ã—ã€æ‚£è€…ã•ã‚“ã«é¸ã°ã‚Œã‚‹ç¢ºç‡ã‚’é«˜ã‚ã¾ã™ã€‚ç™»éŒ²ã™ã‚‹ã ã‘ã§æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆãŒ +100pt åŠ ç®—ã•ã‚Œã€ã‚¨ãƒªã‚¢å†…ã§ã®éœ²å‡ºãŒå¤§ããå‘ä¸Šã—ã¾ã™ã€‚',
  },
  reserve_public: {
    icon: 'ğŸ“…', title: 'ãƒãƒƒãƒˆäºˆç´„ã‚’å…¬é–‹è¨­å®šã«ã™ã‚‹', pt: '+50pt',
    desc: '24æ™‚é–“ã„ã¤ã§ã‚‚äºˆç´„ã‚’å—ã‘ä»˜ã‘ã‚‰ã‚Œã‚‹çŠ¶æ…‹ã«ã™ã‚‹ã“ã¨ã§ã€æ©Ÿä¼šæå¤±ã‚’ã‚¼ãƒ­ã«ã—ã¾ã™ã€‚äºˆç´„å…¬é–‹ã¯æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ +50pt ã®ç²å¾—ã«ã‚‚ç›´çµã—ã¾ã™ã€‚',
  },
  reserve_gmb: {
    icon: 'ğŸ“', title: 'Googleãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«URLã‚’è¨­ç½®ã™ã‚‹', pt: '+50pt',
    desc: 'Googleæ¤œç´¢ãƒ»ãƒãƒƒãƒ—ã‹ã‚‰ç›´æ¥ã‚³ãƒ³ãƒ‘ã‚¹ã¸ã®å°ç·šã‚’ä½œã‚Šã¾ã™ã€‚å¤–éƒ¨ã‹ã‚‰ã®æ–°è¦æµå…¥ãŒå¢—ãˆã€ã‚¢ã‚¯ã‚»ã‚¹æ•°ã‚¢ãƒƒãƒ—ã«ç›´çµã€‚æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆã‚‚ +50pt ç²å¾—ã§ãã¾ã™ã€‚',
  },
  reserve_banner: {
    icon: 'ğŸ”—', title: 'ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«äºˆç´„ãƒãƒŠãƒ¼ã‚’è¨­ç½®ã™ã‚‹', pt: '+50pt',
    desc: 'è‡ªé™¢ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚³ãƒ³ãƒ‘ã‚¹ã¸ã®äºˆç´„å°ç·šã‚’è¨­ç½®ã—ã¾ã™ã€‚æ—¢å­˜ãƒ»æ–°è¦æ‚£è€…ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¢—åŠ ã—ã€æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ +50pt ã‚‚ç²å¾—ã§ãã¾ã™ã€‚',
  },
  compass_link: {
    icon: 'ğŸ”„', title: 'ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ç›¸äº’ãƒªãƒ³ã‚¯ã‚’è¨­ç½®ã™ã‚‹', pt: '+30pt',
    desc: 'ã‚³ãƒ³ãƒ‘ã‚¹ã¨ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’ç›¸äº’ãƒªãƒ³ã‚¯ã§çµã¶ã“ã¨ã§ã€SEOåŠ¹æœã¨æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ +30pt ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚è¨­ç½®ã¯ä»£è¡Œä¾é ¼ã‚‚å¯èƒ½ã§ã™ã€‚',
  },
  review_parts: {
    icon: 'â­', title: 'å£ã‚³ãƒŸãƒ‘ãƒ¼ãƒ„ã‚’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«è¨­ç½®ã™ã‚‹', pt: '+30pt',
    desc: 'æ‚£è€…ã•ã‚“ã®ç”Ÿã®å£°ã‚’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã‚‹ã“ã¨ã§ã€åˆã‚ã¦è¨ªã‚Œã‚‹æ–¹ã®ä¿¡é ¼æ„ŸãŒé«˜ã¾ã‚Šã¾ã™ã€‚æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ +30pt ã«ã‚‚åŠ ç®—ã•ã‚Œã¾ã™ã€‚',
  },
  review: {
    icon: 'ğŸ’¬', title: 'å£ã‚³ãƒŸã‚’å¢—ã‚„ã™ï¼ˆç›®æ¨™5ä»¶ï¼‰', pt: '1ä»¶ã”ã¨åŠ ç®—',
    desc: 'å£ã‚³ãƒŸã¯ã‚¯ãƒªãƒƒã‚¯ç‡ã«ç›´çµã™ã‚‹æœ€é‡è¦æŒ‡æ¨™ã§ã™ã€‚æ¥é™¢æ‚£è€…ã•ã‚“ã¸ã®å£°æ›ã‘ã‚„ã‚«ãƒ¼ãƒ‰é…å¸ƒã‚’ç¿’æ…£åŒ–ã—ã€1ä»¶ãšã¤ç€å®Ÿã«ç©ã¿ä¸Šã’ã¾ã—ã‚‡ã†ã€‚å£ã‚³ãƒŸ1ä»¶ã”ã¨ã«ãƒã‚¤ãƒ³ãƒˆã‚‚åŠ ç®—ã•ã‚Œã¾ã™ã€‚',
  },
  review_reply: {
    icon: 'âœï¸', title: 'å£ã‚³ãƒŸã«è¿”ä¿¡ã™ã‚‹ï¼ˆç›®æ¨™5ä»¶ï¼‰', pt: '1ä»¶ã”ã¨åŠ ç®—',
    desc: 'è¿”ä¿¡ã¯ã€Œä¸å¯§ãªé™¢ã€ã¨ã„ã†ä¿¡é ¼æ„Ÿã‚’æ‚£è€…ã•ã‚“ã«ä¼ãˆã¾ã™ã€‚å…¨ä»¶è¿”ä¿¡ã‚’å¾¹åº•ã™ã‚‹ã“ã¨ã§ã€ã‚¯ãƒªãƒƒã‚¯ç‡ã®æ”¹å–„ã¨æ–°è¦æ‚£è€…ã¸ã®å®‰å¿ƒæ„Ÿã«ã¤ãªãŒã‚Šã¾ã™ã€‚',
  },
  pickup_review: {
    icon: 'ğŸŒŸ', title: 'PickUpå£ã‚³ãƒŸã‚’è¨­å®šã™ã‚‹', pt: null,
    desc: 'ã‚‚ã£ã¨ã‚‚å°è±¡çš„ãªå£ã‚³ãƒŸã‚’ãƒˆãƒƒãƒ—ã«è¡¨ç¤ºã™ã‚‹è¨­å®šã§ã™ã€‚åˆã‚ã¦è¨ªã‚ŒãŸæ‚£è€…ã•ã‚“ãŒæœ€åˆã«ç›®ã«ã™ã‚‹æƒ…å ±ã¨ã—ã¦ã€æ¥é™¢ã®æ±ºã‚æ‰‹ã«ãªã‚Šã¾ã™ã€‚',
  },
  menu3: {
    icon: 'ğŸ“‹', title: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’3ä»¶ä»¥ä¸Šç™»éŒ²ã™ã‚‹', pt: null,
    desc: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå……å®Ÿã—ã¦ã„ã‚‹ã¨ã€æ‚£è€…ã•ã‚“ãŒè‡ªåˆ†ã«åˆã£ãŸæ–½è¡“ã‚’è¦‹ã¤ã‘ã‚„ã™ããªã‚Šã¾ã™ã€‚3ä»¶ä»¥ä¸Šã®ç™»éŒ²ã§ã‚¯ãƒªãƒƒã‚¯ç‡ãƒ»äºˆç´„ç‡ã‚¢ãƒƒãƒ—ãŒæœŸå¾…ã§ãã¾ã™ã€‚',
  },
  deadline: {
    icon: 'â°', title: 'äºˆç´„å—ä»˜ç· åˆ‡æ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹ï¼ˆç›®æ¨™60åˆ†ä»¥å†…ï¼‰', pt: null,
    desc: 'ã€Œç›´å‰ã«äºˆç´„ã—ãŸã„ã€æ‚£è€…ã•ã‚“ã‚’é€ƒã•ãªã„ãŸã‚ã«ã€å—ä»˜ç· åˆ‡ã‚’çŸ­ç¸®ã—ã¾ã—ã‚‡ã†ã€‚60åˆ†ä»¥å†…ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€å½“æ—¥ãƒ»ç¿Œæ—¥äºˆç´„ã®å–ã‚Šã“ã¼ã—ã‚’é˜²ã’ã¾ã™ã€‚',
  },
  menu_link: {
    icon: 'ğŸ½ï¸', title: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼é€£æºã‚’è¨­å®šã™ã‚‹', pt: null,
    desc: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’äºˆç´„ã¨é€£æºã•ã›ã‚‹ã“ã¨ã§ã€æ‚£è€…ã•ã‚“ãŒå¸Œæœ›ã®æ–½è¡“ã‚’ãã®ã¾ã¾äºˆç´„ã§ãã‚‹å°ç·šãŒå®Œæˆã—ã¾ã™ã€‚äºˆç´„ç‡ï¼ˆCVRï¼‰ã®å‘ä¸Šã«ç›´æ¥ã¤ãªãŒã‚Šã¾ã™ã€‚',
  },
  guest_reserve: {
    icon: 'ğŸ‘¤', title: 'ã‚²ã‚¹ãƒˆäºˆç´„ã‚’æœ‰åŠ¹ã«ã™ã‚‹', pt: null,
    desc: 'ä¼šå“¡ç™»éŒ²ãªã—ã§äºˆç´„ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€åˆè¨ºã®æ‚£è€…ã•ã‚“ã®ãƒãƒ¼ãƒ‰ãƒ«ã‚’å¤§å¹…ã«ä¸‹ã’ã‚‰ã‚Œã¾ã™ã€‚æ–°è¦æ‚£è€…ã®ç²å¾—ã«ç‰¹ã«åŠ¹æœçš„ã§ã™ã€‚',
  },
};

// å„ªå…ˆåº¦é †ï¼ˆæ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆâ†’å£ã‚³ãƒŸâ†’äºˆç´„è¨­å®šã®é †ï¼‰
const ADVICE_PRIORITY = [
  'store_pr', 'reserve_public', 'reserve_gmb', 'reserve_banner',
  'compass_link', 'review_parts', 'review', 'review_reply',
  'pickup_review', 'menu3', 'deadline', 'menu_link', 'guest_reserve',
];

// ===== ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆï¼ˆæœªé”æˆKPIã‹ã‚‰å„ªå…ˆåº¦é †ã«æœ€å¤§3ä»¶ã‚’é¸å‡ºï¼‰ =====
function generateAdvice(d) {
  const unachieved = new Set();
  for (const [, def] of Object.entries(KPI_DEFS)) {
    for (const item of def.items) {
      if (item.type === 'info' || item.type === 'rate') continue;
      let achieved = false;
      if (item.type === 'num')         achieved = d[item.key] !== null && d[item.key] >= item.threshold;
      else if (item.type === 'flag')   achieved = Number(d[item.key]) >= 1;
      else if (item.type === 'flag_str') achieved = d[item.key] == 1 || d[item.key] === 'å…¬é–‹';
      else if (item.type === 'deadline') achieved = d[item.key] !== null && d[item.key] <= item.threshold;
      if (!achieved) unachieved.add(item.key);
    }
  }
  return ADVICE_PRIORITY.filter(k => unachieved.has(k) && ACTIONS[k] && ADVICE_RICH[k]).slice(0, 3);
}

function renderAdvice(d) {
  const keys = generateAdvice(d);
  const body = document.getElementById('advice-body');

  if (keys.length === 0) {
    body.innerHTML = `<p class="advice-intro">ğŸ‰ ã™ã¹ã¦ã®æ¨å¥¨é …ç›®ã‚’é”æˆä¸­ã§ã™ï¼ã“ã®èª¿å­ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚</p>`;
    document.getElementById('advice-section').style.display = 'block';
    return;
  }

  const cards = keys.map((key, i) => {
    const rich = ADVICE_RICH[key];
    const action = ACTIONS[key];
    const ptBadge = rich.pt ? `<span class="advice-card-pt">â˜… ${rich.pt}</span>` : '';
    const btns = action.links.map(link => {
      if (link.url) return `<a href="${link.url}" target="_blank" class="advice-action-btn">${link.label}</a>`;
      return `<button class="advice-action-btn" onclick="handleActionClick('${link.action}')">${link.label}</button>`;
    }).join('');
    const cardNoteHtml = action.note ? `<p class="advice-card-note">${action.note}</p>` : '';
    return `
      <div class="advice-card">
        <div class="advice-card-head">
          <span class="advice-card-num">${i + 1}</span>
          <span class="advice-card-title">${rich.icon} ${rich.title}</span>
          ${ptBadge}
        </div>
        <p class="advice-card-desc">${rich.desc}</p>
        <div class="advice-card-btns">${btns}</div>
        ${cardNoteHtml}
      </div>`;
  }).join('');

  body.innerHTML = `
    <p class="advice-intro">æœªå¯¾å¿œã®ä¸­ã‹ã‚‰å„ªå…ˆåº¦ã®é«˜ã„3é …ç›®ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ</p>
    <div class="advice-cards">${cards}</div>
  `;
  document.getElementById('advice-section').style.display = 'block';
}

// ===== ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ =====
function renderTrendCharts() {
  document.getElementById('trend-section').style.display = 'block';

  const labels = trendData.map(t => formatSheetName(t.sheet));
  const accessData = trendData.map(t => t.data.access || 0);
  const ctrData = trendData.map(t => t.data.click && t.data.access ? parseFloat((t.data.click / t.data.access * 100).toFixed(1)) : 0);
  const cvrData = trendData.map(t => t.data.net_reserve && t.data.click ? parseFloat((t.data.net_reserve / t.data.click * 100).toFixed(1)) : 0);
  const reviewData = trendData.map(t => t.data.review || 0);

  const makeChart = (id, data, color, label, avgVal) => {
    if (charts[id]) charts[id].destroy();
    const ctx = document.getElementById(id)?.getContext('2d');
    if (!ctx) return;
    const datasets = [{
      label,
      data,
      borderColor: color,
      backgroundColor: color + '18',
      tension: 0,          // ç›´ç·š
      fill: true,
      pointRadius: 5,
      pointHoverRadius: 7,
      borderWidth: 2,
    }];
    // æœ‰æ–™é™¢å¹³å‡ãƒ©ã‚¤ãƒ³
    if (avgVal !== null && avgVal !== undefined) {
      datasets.push({
        label: 'æœ‰æ–™é™¢å¹³å‡',
        data: labels.map(() => avgVal),
        borderColor: '#94a3b8',
        borderDash: [5, 4],
        borderWidth: 1.5,
        pointRadius: 0,
        fill: false,
        tension: 0,
      });
    }
    charts[id] = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false }, // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå€¤ã‚’è¡¨ç¤º
        plugins: {
          legend: {
            display: avgVal !== null && avgVal !== undefined,
            labels: { boxWidth: 24, font: { size: 11 }, color: '#64748b' }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}`
            }
          }
        },
        scales: {
          y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
          x: { grid: { display: false } }
        }
      }
    });
  };

  const av = avgData || {};
  makeChart('chart-access', accessData, '#0f4c81', 'ã‚¢ã‚¯ã‚»ã‚¹æ•°',    av.access ?? null);
  makeChart('chart-ctr',    ctrData,    '#2563EB', 'ã‚¯ãƒªãƒƒã‚¯ç‡(%)', av.ctr    ?? null);
  makeChart('chart-cvr',    cvrData,    '#e67e22', 'ãƒãƒƒãƒˆäºˆç´„ç‡(%)',av.cvr    ?? null);
  makeChart('chart-review', reviewData, '#00a86b', 'å£ã‚³ãƒŸä»¶æ•°',    av.review ?? null);
}

// ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
function handleLogout() {
  sendLoginLog();
  currentData = null;
  trendData = [];
  avgData = null;
  Object.values(charts).forEach(c => c.destroy());
  charts = {};
  document.getElementById('salon-id-input').value = '';
  document.getElementById('email-input').value = '';
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('kpi-sections').innerHTML = '';
  document.getElementById('trend-section').style.display = 'none';
  document.getElementById('qr-section').style.display = 'none';
}

// Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
document.getElementById('salon-id-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleLogin();
});
document.getElementById('email-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleLogin();
});

// ===== ãƒ­ã‚°é€ä¿¡ =====
function getDeviceInfo() {
  const ua = navigator.userAgent;
  const type = /iPhone|Android.*Mobile/.test(ua) ? 'ã‚¹ãƒãƒ›'
    : /iPad|Android/.test(ua) ? 'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ' : 'PC';
  const browser = /Edg\//.test(ua) ? 'Edge'
    : /Chrome\//.test(ua) ? 'Chrome'
    : /Safari\//.test(ua) ? 'Safari'
    : /Firefox\//.test(ua) ? 'Firefox' : 'ãã®ä»–';
  return `${type}/${browser}`;
}

function trackUrl(url) {
  if (isInternal || !url || sessionClickedUrls.length >= 10) return;
  sessionClickedUrls.push(url);
}

function sendLoginLog() {
  if (isInternal || !currentData || logSent || !GAS_LOG_URL) return;
  logSent = true;
  const payload = {
    datetime: loginTime
      ? loginTime.toLocaleString('ja-JP')
      : new Date().toLocaleString('ja-JP'),
    salon_id:   currentData.salon_id || '',
    salon_name: currentData.name     || '',
    device:     getDeviceInfo(),
    urls:       sessionClickedUrls.slice(0, 10)
  };
  const fd = new FormData();
  fd.append('data', JSON.stringify(payload));
  fetch(GAS_LOG_URL, { method: 'POST', body: fd, mode: 'no-cors', keepalive: true });
}

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å†…ã®å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ã‚’è¿½è·¡
document.getElementById('dashboard').addEventListener('click', (e) => {
  if (isInternal) return;
  const a = e.target.closest('a[href]');
  if (a && /^https?:/.test(a.href)) trackUrl(a.href);
});

// ã‚¿ãƒ–ã‚’é–‰ã˜ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é€ä¿¡
window.addEventListener('beforeunload', () => sendLoginLog());

</script>
</body>
</html>
