<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KPIãƒ•ã‚©ãƒ­ãƒ¼ãƒ„ãƒ¼ãƒ«ï½œã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #0f4c81;
    --primary-light: #1a6db5;
    --accent: #00a86b;
    --accent-light: #e6f7f1;
    --warning: #e67e22;
    --warning-light: #fef3e2;
    --danger: #e74c3c;
    --danger-light: #fdecea;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-400: #94a3b8;
    --gray-600: #475569;
    --gray-800: #1e293b;
    --white: #ffffff;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--gray-50);
    color: var(--gray-800);
    min-height: 100vh;
  }

  /* ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== */
  #login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0f4c81 0%, #1a6db5 50%, #00a86b 100%);
    padding: 20px;
  }

  .login-card {
    background: var(--white);
    border-radius: 20px;
    padding: 48px 40px;
    width: 100%;
    max-width: 400px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }

  .login-logo {
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-400);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .login-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 32px;
    line-height: 1.4;
  }

  .login-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-600);
    text-align: left;
    margin-bottom: 8px;
  }

  .login-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-sm);
    font-size: 16px;
    font-family: 'Inter', sans-serif;
    color: var(--gray-800);
    transition: border-color 0.2s;
    outline: none;
    margin-bottom: 20px;
  }

  .login-input:focus { border-color: var(--primary-light); }

  .login-btn {
    width: 100%;
    padding: 14px;
    background: var(--primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-weight: 700;
    font-family: 'Noto Sans JP', sans-serif;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }

  .login-btn:hover { background: var(--primary-light); transform: translateY(-1px); }
  .login-btn:active { transform: translateY(0); }

  .login-error {
    margin-top: 16px;
    padding: 12px;
    background: var(--danger-light);
    border-radius: var(--radius-sm);
    color: var(--danger);
    font-size: 13px;
    display: none;
  }

  /* ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ===== */
  #dashboard { display: none; }

  .top-bar {
    background: var(--primary);
    color: var(--white);
    padding: 0 24px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-md);
  }

  .top-bar-left {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  .top-bar-right {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .contact-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .contact-btn:hover { opacity: 0.85; }
  .contact-btn.line { background: #06C755; color: white; }
  .contact-btn.mail { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); }

  .logout-btn {
    background: none;
    border: 1px solid rgba(255,255,255,0.4);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .logout-btn:hover { background: rgba(255,255,255,0.15); }

  .main-content {
    max-width: 1000px;
    margin: 0 auto;
    padding: 24px 16px 60px;
  }

  /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ ===== */
  .header-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 24px 28px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--primary);
  }

  .salon-name {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
  }

  .data-date {
    font-size: 12px;
    color: var(--gray-400);
    margin-bottom: 16px;
  }

  .rank-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .rank-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 10px 20px;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 700;
  }

  .rank-badge .rank-num {
    font-size: 24px;
    font-family: 'Inter', sans-serif;
  }

  .search-point-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--accent-light);
    color: var(--accent);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
  }

  /* ===== é”æˆçŠ¶æ³ã‚µãƒãƒªãƒ¼ ===== */
  .summary-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  .summary-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
    box-shadow: var(--shadow-sm);
  }

  .summary-num {
    font-size: 28px;
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    line-height: 1;
    margin-bottom: 4px;
  }

  .summary-label { font-size: 12px; color: var(--gray-600); }
  .summary-card.achieved .summary-num { color: var(--accent); }
  .summary-card.unachieved .summary-num { color: var(--danger); }
  .summary-card.total .summary-num { color: var(--primary); }

  /* ===== ãƒ‹ãƒ¼ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
  .needs-section {
    margin-bottom: 20px;
  }

  .needs-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 20px;
    border-radius: var(--radius) var(--radius) 0 0;
    font-size: 15px;
    font-weight: 700;
  }

  .needs-header.search { background: linear-gradient(90deg, #1a3a5c, #2563EB); color: white; }
  .needs-header.click { background: linear-gradient(90deg, #1a5c3a, #00a86b); color: white; }
  .needs-header.reserve { background: linear-gradient(90deg, #5c3a1a, #e67e22); color: white; }

  .needs-emoji { font-size: 20px; }

  .needs-body {
    background: var(--white);
    border-radius: 0 0 var(--radius) var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  /* ===== KPIã‚¢ã‚¤ãƒ†ãƒ  ===== */
  .kpi-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 20px;
    border-bottom: 1px solid var(--gray-100);
    transition: background 0.15s;
  }

  .kpi-item:last-child { border-bottom: none; }
  .kpi-item:hover { background: var(--gray-50); }
  .kpi-item.unachieved { background: #fffbf8; }

  .kpi-status {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .kpi-status.ok { background: var(--accent-light); color: var(--accent); }
  .kpi-status.ng { background: var(--danger-light); color: var(--danger); }

  .kpi-main { flex: 1; min-width: 0; }

  .kpi-name-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
    flex-wrap: wrap;
  }

  .kpi-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
  }

  .kpi-point-badge {
    font-size: 10px;
    font-weight: 700;
    background: #fff3cd;
    color: #856404;
    padding: 2px 7px;
    border-radius: 10px;
    white-space: nowrap;
  }

  .kpi-values {
    font-size: 12px;
    color: var(--gray-400);
  }

  .kpi-values .current {
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
  }

  .kpi-values .current.ok { color: var(--accent); }
  .kpi-values .current.ng { color: var(--danger); }

  /* ===== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœãƒƒã‚¯ã‚¹ ===== */
  .action-box {
    margin: 8px 0 4px 0;
    padding: 12px 14px;
    background: var(--warning-light);
    border-left: 3px solid var(--warning);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    font-size: 13px;
    color: var(--gray-800);
  }

  .action-title {
    font-weight: 700;
    color: var(--warning);
    margin-bottom: 6px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .action-links {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .action-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    background: var(--white);
    border: 1px solid var(--warning);
    color: var(--warning);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
    cursor: pointer;
  }

  .action-link:hover {
    background: var(--warning);
    color: white;
  }

  .action-link.primary {
    background: var(--warning);
    color: white;
  }

  .action-link.primary:hover { opacity: 0.85; }

  /* ===== ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ ===== */
  .trend-section {
    background: var(--white);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
  }

  .section-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .trend-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .trend-chart-wrap {
    background: var(--gray-50);
    border-radius: var(--radius-sm);
    padding: 12px;
  }

  .trend-chart-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-600);
    margin-bottom: 8px;
  }

  canvas { width: 100% !important; }

  /* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15,76,129,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    color: white;
    gap: 16px;
  }

  .spinner {
    width: 44px;
    height: 44px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { font-size: 14px; font-weight: 500; }

  /* ===== infoå‹KPIã‚¢ã‚¤ãƒ†ãƒ  ===== */
  .kpi-item.info-item { background: var(--white); }
  .kpi-status.info { background: var(--gray-100); color: var(--gray-400); font-size: 12px; }
  .kpi-values .current.info { color: var(--primary); font-size: 16px; font-weight: 700; }

  /* ===== ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
  .advice-section {
    background: var(--white);
    border-radius: var(--radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .advice-header {
    background: linear-gradient(90deg, #4a1a7a, #7c3aed);
    color: white;
    padding: 14px 20px;
    font-size: 15px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .advice-body { padding: 20px; }

  .advice-item { margin-bottom: 16px; }
  .advice-item:last-child { margin-bottom: 0; }

  .advice-intro {
    font-size: 13px;
    font-weight: 700;
    color: #7c3aed;
    margin: 0 0 12px;
  }

  .advice-actions {
    margin: 0;
    padding-left: 22px;
  }
  .advice-actions li {
    font-size: 14px;
    line-height: 1.8;
    color: var(--gray-800);
    margin-bottom: 10px;
  }
  .advice-actions li:last-child { margin-bottom: 0; }

  /* ===== åŠªåŠ›ç›®æ¨™ãƒãƒŠãƒ¼ ===== */
  .goal-banner {
    background: linear-gradient(135deg, #ede9fe, #f5f3ff);
    border: 1.5px solid #c4b5fd;
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    margin: 8px 0 4px;
    font-size: 13px;
    color: #4c1d95;
    line-height: 1.7;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }
  .goal-banner strong { color: #7c3aed; font-size: 15px; }

  /* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ===== */
  @media (max-width: 600px) {
    .summary-row { grid-template-columns: repeat(3,1fr); gap: 8px; }
    .summary-num { font-size: 22px; }
    .trend-grid { grid-template-columns: 1fr; }
    .login-card { padding: 32px 24px; }
    .top-bar { padding: 0 12px; }
    .contact-btn span { display: none; }
  }
</style>
</head>
<body>

<!-- ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== -->
<div class="loading-overlay" id="loading" style="display:none;">
  <div class="spinner"></div>
  <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
</div>

<!-- ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹</div>
    <div class="login-title">KPIãƒ•ã‚©ãƒ­ãƒ¼ãƒ„ãƒ¼ãƒ«</div>
    <label class="login-label">ã‚µãƒ­ãƒ³ID</label>
    <input type="text" id="salon-id-input" class="login-input" placeholder="ä¾‹ï¼š12345" />
    <label class="login-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
    <input type="email" id="email-input" class="login-input" placeholder="ä¾‹ï¼šinfo@example.com" />
    <button class="login-btn" onclick="handleLogin()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º</button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ===== -->
<div id="dashboard">
  <div class="top-bar">
    <div class="top-bar-left">ğŸ“Š KPIãƒ•ã‚©ãƒ­ãƒ¼ãƒ„ãƒ¼ãƒ«</div>
    <div class="top-bar-right">
      <a href="#" target="_blank" class="contact-btn line">ğŸ’¬ <span>LINEç›¸è«‡</span></a>
      <a href="mailto:info@shinq-compass.jp" class="contact-btn mail">âœ‰ï¸ <span>ãƒ¡ãƒ¼ãƒ«ç›¸è«‡</span></a>
      <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <div class="main-content">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ -->
    <div class="header-card">
      <div class="salon-name" id="salon-name">â€•</div>
      <div class="data-date" id="data-date">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>
      <div class="rank-row">
        <div class="rank-badge" id="rank-badge" style="display:none;">
          <span>ã‚¨ãƒªã‚¢å†…é †ä½</span>
          <span class="rank-num" id="area-rank">â€•</span>
          <span>ä½</span>
        </div>
        <div class="search-point-badge" id="point-badge" style="display:none;">
          â­ æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆï¼š<strong id="search-point">â€•</strong> pt
        </div>
      </div>
    </div>

    <!-- åŠªåŠ›ç›®æ¨™ãƒãƒŠãƒ¼ -->
    <div class="goal-banner" id="goal-banner" style="display:none;">
      <span>ğŸ¯</span>
      <span id="goal-text"></span>
    </div>

    <!-- é”æˆã‚µãƒãƒªãƒ¼ -->
    <div class="summary-row">
      <div class="summary-card achieved">
        <div class="summary-num" id="achieved-count">â€•</div>
        <div class="summary-label">é”æˆä¸­</div>
      </div>
      <div class="summary-card unachieved">
        <div class="summary-num" id="unachieved-count">â€•</div>
        <div class="summary-label">æœªé”ãƒ»æœªè¨­å®š</div>
      </div>
      <div class="summary-card total">
        <div class="summary-num" id="total-count">â€•</div>
        <div class="summary-label">å¯¾è±¡KPIæ•°</div>
      </div>
    </div>

    <!-- ãƒ‹ãƒ¼ã‚ºåˆ¥KPI -->
    <div id="kpi-sections"></div>

    <!-- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
    <div class="advice-section" id="advice-section" style="display:none;">
      <div class="advice-header">ğŸ’¡ ä»Šæœˆã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
      <div class="advice-body" id="advice-body"></div>
    </div>

    <!-- ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ• -->
    <div class="trend-section" id="trend-section" style="display:none;">
      <div class="section-title">ğŸ“ˆ æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆç›´è¿‘6ãƒ¶æœˆï¼‰</div>
      <div class="trend-grid">
        <div class="trend-chart-wrap">
          <div class="trend-chart-title">ã‚¢ã‚¯ã‚»ã‚¹æ•°</div>
          <canvas id="chart-access"></canvas>
        </div>
        <div class="trend-chart-wrap">
          <div class="trend-chart-title">ã‚¯ãƒªãƒƒã‚¯ç‡ï¼ˆ%ï¼‰</div>
          <canvas id="chart-ctr"></canvas>
        </div>
        <div class="trend-chart-wrap">
          <div class="trend-chart-title">ãƒãƒƒãƒˆäºˆç´„ç‡ï¼ˆ%ï¼‰</div>
          <canvas id="chart-cvr"></canvas>
        </div>
        <div class="trend-chart-wrap">
          <div class="trend-chart-title">å£ã‚³ãƒŸä»¶æ•°</div>
          <canvas id="chart-review"></canvas>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
// ===== è¨­å®šï¼ˆã“ã“ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰ =====
const API_KEY = 'AIzaSyAK_wtY_WFgOkw3L55BkWpmCQuzmhDpsIw'; // â† ç™ºè¡Œã—ãŸAPIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
const SPREADSHEET_ID = '1CiuXRdYG-lI_jWA4DiR_uXvYU9dgqTE1v-JWsZF1l_g';

// æœˆåˆ¥ã‚¿ãƒ–ï¼ˆæ–°ã—ã„é †ã«è¿½åŠ ã—ã¦ã„ãã€‚æ¯æœˆå…ˆé ­ã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰
const MONTHLY_SHEETS = ['2602', '2601', '2512'];
const FREE_TRIAL_SHEET = 'ç„¡æ–™ä½“é¨“';

// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®åˆ—ç•ªå·ï¼ˆAåˆ—=0ã€Dåˆ—=3ï¼‰
const EMAIL_COL = 3;

// ã‚¨ãƒªã‚¢å†…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®åˆ—ç•ªå·ï¼ˆAVåˆ—=47ï¼‰
const AREA_RANK_COL = 47;

// æ‹…å½“è€…é€£çµ¡å…ˆ
const LINE_URL = 'https://line.me/ti/p/@348cwzis';
const MAIL_ADDRESS = 'info@shinq-compass.jp';

// ===== KPIå®šç¾© =====
const KPI_DEFS = {
  // ãƒ‹ãƒ¼ã‚º1: æ¤œç´¢ã§è¦‹ã¤ã‘ã¦ã‚‚ã‚‰ã†
  search: {
    label: 'ğŸ” æ¤œç´¢ã§è¦‹ã¤ã‘ã¦ã‚‚ã‚‰ã†',
    theme: 'search',
    items: [
      { key: 'access', name: 'ã‚¢ã‚¯ã‚»ã‚¹æ•°', col: 12, threshold: 200, type: 'num', unit: '', searchPoint: false },
      { key: 'store_pr', name: 'åº—èˆ—PRæƒ…å ±ç™»éŒ²', col: 31, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 100 },
      { key: 'reserve_public', name: 'äºˆç´„å…¬é–‹åˆ©ç”¨é™¢', col: 27, threshold: 1, type: 'flag_str', unit: '', searchPoint: true, point: 50 },
      { key: 'reserve_gmb', name: 'äºˆç´„GMBè¨­ç½®', col: 28, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 50 },
      { key: 'reserve_banner', name: 'äºˆç´„ãƒãƒŠãƒ¼è¨­ç½®', col: 29, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 50 },
      { key: 'compass_link', name: 'ã‚³ãƒ³ãƒ‘ã‚¹ç›¸äº’ãƒªãƒ³ã‚¯è¨­ç½®', col: 30, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 30 },
    ]
  },
  // ãƒ‹ãƒ¼ã‚º2: äºˆç´„ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†
  click: {
    label: 'ğŸ‘† äºˆç´„ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†',
    theme: 'click',
    items: [
      { key: 'click', name: 'ã‚¯ãƒªãƒƒã‚¯æ•°', threshold: 20, type: 'num', unit: 'å›', searchPoint: false },
      { key: 'ctr', name: 'ã‚¯ãƒªãƒƒã‚¯ç‡', threshold: 10, type: 'rate', unit: '%', searchPoint: false, calc: (d) => d.access > 0 ? (d.click / d.access * 100) : null },
      { key: 'review', name: 'å£ã‚³ãƒŸä»¶æ•°', col: 23, threshold: 5, type: 'num', unit: 'ä»¶', searchPoint: true, point: '1ä»¶ã”ã¨' },
      { key: 'review_reply', name: 'å£ã‚³ãƒŸè¿”ä¿¡ä»¶æ•°', col: 24, threshold: 5, type: 'num', unit: 'ä»¶', searchPoint: true, point: '1ä»¶ã”ã¨' },
      { key: 'pickup_review', name: 'PickUpå£ã‚³ãƒŸ', col: 25, threshold: 1, type: 'flag', unit: '', searchPoint: false },
      { key: 'review_parts', name: 'å£ã‚³ãƒŸãƒ‘ãƒ¼ãƒ„è¨­ç½®', col: 26, threshold: 1, type: 'flag', unit: '', searchPoint: true, point: 30 },
      { key: 'menu3', name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼3ä»¶ä»¥ä¸Šç™»éŒ²', col: 32, threshold: 1, type: 'flag', unit: '', searchPoint: false },
    ]
  },
  // ãƒ‹ãƒ¼ã‚º3: å®Ÿéš›ã«äºˆç´„ã—ã¦ã‚‚ã‚‰ã†
  reserve: {
    label: 'ğŸ“… å®Ÿéš›ã«äºˆç´„ã—ã¦ã‚‚ã‚‰ã†',
    theme: 'reserve',
    items: [
      { key: 'net_reserve', name: 'äºˆç´„æ•°', threshold: 2, type: 'num', unit: 'ä»¶', searchPoint: false },
      { key: 'cvr', name: 'ãƒãƒƒãƒˆäºˆç´„ç‡', threshold: 10, type: 'rate', unit: '%', searchPoint: false, calc: (d) => d.click > 0 ? (d.net_reserve / d.click * 100) : null },
      { key: 'menu_link', name: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼é€£æº', col: 33, threshold: 1, type: 'flag', unit: '', searchPoint: false },
      { key: 'guest_reserve', name: 'ã‚²ã‚¹ãƒˆäºˆç´„åˆ©ç”¨', col: 36, threshold: 1, type: 'flag', unit: '', searchPoint: false },
      { key: 'deadline', name: 'äºˆç´„å—ä»˜ç· åˆ‡æ™‚é–“', col: 37, threshold: 60, type: 'deadline', unit: 'åˆ†', searchPoint: false },
    ]
  }
};

// ===== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾© =====
const ACTIONS = {
  access: {
    text: 'ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¢—ã‚„ã™ãŸã‚ã«ã€ä»¥ä¸‹ã®æ–½ç­–ã‚’å®Ÿæ–½ã—ã¾ã—ã‚‡ã†ã€‚',
    links: [
      { label: 'ğŸ” æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆå¯¾è±¡KPIã‚’ç¢ºèªã™ã‚‹', action: 'scroll_search' },
      { label: 'ğŸ”— äºˆç´„å°ç·šç³»KPIã‚’ç¢ºèªã™ã‚‹', action: 'scroll_reserve' },
    ]
  },
  ctr: {
    text: 'ã‚¯ãƒªãƒƒã‚¯ç‡ã‚’ä¸Šã’ã‚‹ãŸã‚ã«ã€å£ã‚³ãƒŸã‚’å¼·åŒ–ã—ã¦æ‚£è€…ã•ã‚“ã®åå¿œã‚’é«˜ã‚ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'ğŸ’¬ å£ã‚³ãƒŸç³»KPIã‚’ç¢ºèªã™ã‚‹', action: 'scroll_click' }]
  },
  review: {
    text: 'å£ã‚³ãƒŸã‚’å¢—ã‚„ã™ãŸã‚ã«ã€ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ã‚’ã”æ´»ç”¨ãã ã•ã„ã€‚',
    links: [
      { label: 'ğŸ“„ å£ã‚³ãƒŸä»£ç†æŠ•ç¨¿ç”¨ç´™ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', url: 'https://example.com/review_form.pdf' },
      { label: 'ğŸ“± QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹', action: 'show_qr' },
      { label: 'ğŸ“‹ é™¢å†…è¨­ç½®ç”¨PDFï¼ˆ3æšï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', url: 'https://example.com/review_guide.pdf' },
    ]
  },
  review_reply: {
    text: 'å£ã‚³ãƒŸã¸ã®è¿”ä¿¡ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚è¿”ä¿¡ã²ãªå½¢ç”Ÿæˆãƒ„ãƒ¼ãƒ«ã‚‚æ´»ç”¨ã§ãã¾ã™ã€‚',
    links: [
      { label: 'ğŸ’¬ å£ã‚³ãƒŸè¿”ä¿¡ãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' },
      { label: 'âœï¸ è¿”ä¿¡ã²ãªå½¢ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹', url: 'https://example.com/reply-tool' },
    ]
  },
  pickup_review: {
    text: 'PickUpå£ã‚³ãƒŸã‚’è¨­å®šã—ã¦ã€æ‚£è€…ã•ã‚“ã®å°è±¡çš„ãªå£°ã‚’ç›®ç«‹ãŸã›ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' }]
  },
  review_parts: {
    text: 'å£ã‚³ãƒŸãƒ‘ãƒ¼ãƒ„ã‚’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«è¨­ç½®ã—ã¦ã€æ‚£è€…ã•ã‚“ã«ä¿¡é ¼æ„Ÿã‚’ä¸ãˆã¾ã—ã‚‡ã†ã€‚',
    links: [
      { label: 'ğŸ› ï¸ ä»£è¡Œè¨­ç½®ã‚’ä¾é ¼ã™ã‚‹ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰', url: 'https://forms.gle/YOUR_FORM_ID' },
      { label: 'ğŸ“‹ è‡ªåˆ†ã§è¨­ç½®ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰', url: 'https://admin.shinq-compass.jp/' },
    ]
  },
  store_pr: {
    text: 'åº—èˆ—PRæƒ…å ±ã‚’ç™»éŒ²ã—ã¦ã€æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼ˆ+100ptï¼‰ã€‚',
    links: [{ label: 'âš™ï¸ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' }]
  },
  menu3: {
    text: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’3ä»¶ä»¥ä¸Šç™»éŒ²ã—ã¦ã€æ‚£è€…ã•ã‚“ã«é¸ã°ã‚Œã‚„ã™ãã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' }]
  },
  reserve_public: {
    text: 'ã—ã‚“ãã‚…ã†äºˆç´„ã‚’å…¬é–‹è¨­å®šã«ã—ã¦ã€ãƒãƒƒãƒˆäºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ã‚‡ã†ï¼ˆ+50ptï¼‰ã€‚',
    links: [{ label: 'âš™ï¸ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' }]
  },
  reserve_gmb: {
    text: 'Googleãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«ã—ã‚“ãã‚…ã†URLã‚’è¨­ç½®ã—ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ï¼ˆ+50ptï¼‰ã€‚',
    links: [
      { label: 'ğŸ› ï¸ ä»£è¡Œè¨­å®šã‚’ä¾é ¼ã™ã‚‹ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰', url: 'https://forms.gle/YOUR_FORM_ID' },
      { label: 'ğŸ“‹ è‡ªåˆ†ã§è¨­å®šã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰', url: 'https://business.google.com/' },
    ]
  },
  reserve_banner: {
    text: 'äºˆç´„ãƒãƒŠãƒ¼ã‚’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«è¨­ç½®ã—ã¦ã€äºˆç´„ã¸ã®å°ç·šã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†ï¼ˆ+50ptï¼‰ã€‚',
    links: [
      { label: 'ğŸ› ï¸ ä»£è¡Œè¨­ç½®ã‚’ä¾é ¼ã™ã‚‹ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰', url: 'https://forms.gle/YOUR_FORM_ID' },
      { label: 'ğŸ“‹ è‡ªåˆ†ã§è¨­ç½®ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰', url: 'https://admin.shinq-compass.jp/' },
    ]
  },
  compass_link: {
    text: 'ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ã‚³ãƒ³ãƒ‘ã‚¹ã¸ã®ç›¸äº’ãƒªãƒ³ã‚¯ã‚’è¨­ç½®ã—ã¦ã€æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼ˆ+30ptï¼‰ã€‚',
    links: [
      { label: 'ğŸ› ï¸ ä»£è¡Œè¨­ç½®ã‚’ä¾é ¼ã™ã‚‹ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰', url: 'https://forms.gle/YOUR_FORM_ID' },
      { label: 'ğŸ“‹ è‡ªåˆ†ã§è¨­ç½®ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰', url: 'https://admin.shinq-compass.jp/' },
    ]
  },
  menu_link: {
    text: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼é€£æºã‚’è¨­å®šã—ã¦ã€æ‚£è€…ã•ã‚“ãŒã‚¹ãƒ ãƒ¼ã‚ºã«äºˆç´„ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' }]
  },
  guest_reserve: {
    text: 'ã‚²ã‚¹ãƒˆäºˆç´„ã‚’æœ‰åŠ¹ã«ã—ã¦ã€åˆè¨ºã®æ‚£è€…ã•ã‚“ãŒäºˆç´„ã—ã‚„ã™ãã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' }]
  },
  deadline: {
    text: 'äºˆç´„å—ä»˜ç· åˆ‡ã‚’1æ™‚é–“ä»¥å†…ã«è¨­å®šã—ã¦ã€ç›´å‰ã®äºˆç´„ã‚’å–ã‚Šã“ã¼ã•ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'âš™ï¸ ã—ã‚“ãã‚…ã†ã‚³ãƒ³ãƒ‘ã‚¹è¨­å®šãƒšãƒ¼ã‚¸ã¸', url: 'https://admin.shinq-compass.jp/' }]
  },
  cvr: {
    text: 'ãƒãƒƒãƒˆäºˆç´„ç‡ã‚’ä¸Šã’ã‚‹ãŸã‚ã«ã€äºˆç´„è¨­å®šç³»ã®KPIã‚’å®Ÿæ–½ã—ã¾ã—ã‚‡ã†ã€‚',
    links: [{ label: 'ğŸ“… äºˆç´„è¨­å®šç³»KPIã‚’ç¢ºèªã™ã‚‹', action: 'scroll_reserve' }]
  },
};

// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
let currentData = null;
let trendData = [];
let charts = {};

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
function formatSheetName(name) {
  // 'YYMM' å½¢å¼ã®ã‚·ãƒ¼ãƒˆåã‚’ '20YYå¹´Mæœˆåˆ†' ã«å¤‰æ›
  if (/^\d{4}$/.test(name)) {
    const year = 2000 + parseInt(name.slice(0, 2));
    const month = parseInt(name.slice(2));
    return `${year}å¹´${month}æœˆåˆ†`;
  }
  return name;
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

function extractValue(cell) {
  if (cell === null || cell === undefined) return null;
  const str = String(cell);
  const match = str.match(/,"([^"]*?)"\)$/);
  if (match) return match[1];
  const match2 = str.match(/,([\d.]+)\)$/);
  if (match2) return parseFloat(match2[1]);
  return str;
}

async function fetchSheet(sheetName, range = 'A1:BZ1200') {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}!${range}?key=${API_KEY}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`ã‚·ãƒ¼ãƒˆå–å¾—å¤±æ•—: ${sheetName}`);
  const json = await res.json();
  return json.values || [];
}

function parseRow(row, isMonthly) {
  const get = (idx) => {
    const val = row[idx];
    if (val === undefined || val === null || val === '' || val === '#N/A') return null;
    const num = parseFloat(val);
    return isNaN(num) ? val : num;
  };

  if (isMonthly) {
    return {
      salon_id: String(get(0) || '').trim(),
      name: get(1),
      email: String(row[EMAIL_COL] || '').trim().toLowerCase(),
      area: get(6),
      area_rank: AREA_RANK_COL !== null ? get(AREA_RANK_COL) : null,
      search_point: get(10),
      access: get(12),
      click: get(13),
      net_reserve: get(14),
      reserve_public: get(15),
      review: get(23),
      review_reply: get(24),
      pickup_review: get(25),
      review_parts: get(26),
      reserve_public_flag: get(27),
      reserve_gmb: get(28),
      reserve_banner: get(29),
      compass_link: get(30),
      store_pr: get(31),
      menu3: get(32),
      menu_link: get(33),
      guest_reserve: get(36),
      deadline: get(37),
    };
  } else {
    // ç„¡æ–™ä½“é¨“ã‚¿ãƒ–
    return {
      salon_id: String(get(0) || '').trim(),
      name: get(4),
      email: String(row[EMAIL_COL] || '').trim().toLowerCase(),
      area: get(11),
      area_rank: AREA_RANK_COL !== null ? get(AREA_RANK_COL) : null,
      search_point: get(18),
      access: get(13),
      click: get(15),
      net_reserve: get(17),
      reserve_public: null,
      review: get(37),
      review_reply: get(38),
      pickup_review: get(24),
      review_parts: get(23),
      reserve_public_flag: get(19),
      reserve_gmb: get(20),
      reserve_banner: get(21),
      compass_link: get(22),
      store_pr: get(25),
      menu3: get(26),
      menu_link: get(27),
      guest_reserve: get(30),
      deadline: get(31),
    };
  }
}

// ===== ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† =====
async function handleLogin() {
  const salonId = document.getElementById('salon-id-input').value.trim();
  const email = document.getElementById('email-input').value.trim().toLowerCase();
  if (!salonId || !email) {
    const err = document.getElementById('login-error');
    err.textContent = 'ã‚µãƒ­ãƒ³IDã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    err.style.display = 'block';
    return;
  }

  showLoading(true);
  document.getElementById('login-error').style.display = 'none';

  try {
    let found = null;
    let foundSheet = null;
    trendData = [];

    // æœˆåˆ¥ã‚¿ãƒ–ã‚’æ–°ã—ã„é †ã«æ¤œç´¢ï¼ˆå…¨æœˆåˆ†ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚‚åé›†ï¼‰
    for (const sheet of MONTHLY_SHEETS) {
      const rows = await fetchSheet(sheet);
      for (let i = 1; i < rows.length; i++) {
        const id = String(rows[i][0] || '').trim();
        if (id === salonId) {
          const data = parseRow(rows[i], true);
          // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸï¼ˆæœ€æ–°ï¼‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨
          if (!found) {
            found = data;
            foundSheet = sheet;
          }
          // å…¨æœˆåˆ†ã‚’ãƒˆãƒ¬ãƒ³ãƒ‰ç”¨ã«åé›†ï¼ˆå¤ã„é †ã«ãªã‚‹ã‚ˆã†unshiftã§å…ˆé ­è¿½åŠ ï¼‰
          trendData.unshift({ sheet, data });
          break;
        }
      }
    }

    // æœˆåˆ¥ã«è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ç„¡æ–™ä½“é¨“ã‚¿ãƒ–ã‚’æ¤œç´¢
    if (!found) {
      const rows = await fetchSheet(FREE_TRIAL_SHEET);
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const id = String(row[0] || '').trim();
        if (id === salonId) {
          found = parseRow(row, false);
          foundSheet = FREE_TRIAL_SHEET;
          break;
        }
      }
    }

    if (!found) {
      const err = document.getElementById('login-error');
      err.textContent = 'ã‚µãƒ­ãƒ³IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç•ªå·ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
      err.style.display = 'block';
      showLoading(false);
      return;
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç…§åˆ
    if (found.email !== email) {
      const err = document.getElementById('login-error');
      err.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚ã”ç¢ºèªãã ã•ã„ã€‚';
      err.style.display = 'block';
      showLoading(false);
      return;
    }

    currentData = found;
    renderDashboard(found, foundSheet);

  } catch (e) {
    console.error(e);
    document.getElementById('login-error').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
    document.getElementById('login-error').style.display = 'block';
  }

  showLoading(false);
}

// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”» =====
function renderDashboard(d, sheetName) {
  // é™¢åãƒ»æ—¥ä»˜
  document.getElementById('salon-name').textContent = d.name || `ã‚µãƒ­ãƒ³ID: ${d.salon_id}`;
  document.getElementById('data-date').textContent = `ãƒ‡ãƒ¼ã‚¿å‚ç…§å…ƒï¼š${formatSheetName(sheetName)} ï½œ è¡¨ç¤ºæ—¥æ™‚ï¼š${new Date().toLocaleDateString('ja-JP', {year:'numeric',month:'long',day:'numeric'})}`;

  // ã‚¨ãƒªã‚¢å†…ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  if (d.area_rank !== null && d.area_rank !== undefined) {
    document.getElementById('area-rank').textContent = d.area_rank;
    document.getElementById('rank-badge').style.display = 'flex';
  }

  // æ¤œç´¢å„ªå…ˆãƒã‚¤ãƒ³ãƒˆ
  if (d.search_point !== null) {
    document.getElementById('search-point').textContent = d.search_point;
    document.getElementById('point-badge').style.display = 'flex';
  }

  // KPIã‚»ã‚¯ã‚·ãƒ§ãƒ³æç”»
  let totalAchieved = 0, totalUnachieved = 0, totalCount = 0;

  const sectionsEl = document.getElementById('kpi-sections');
  sectionsEl.innerHTML = '';

  Object.entries(KPI_DEFS).forEach(([needsKey, needsDef]) => {
    const section = document.createElement('div');
    section.className = 'needs-section';
    section.id = `needs-${needsKey}`;

    const header = document.createElement('div');
    header.className = `needs-header ${needsDef.theme}`;
    header.innerHTML = `<span class="needs-emoji"></span><span>${needsDef.label}</span>`;
    section.appendChild(header);

    const body = document.createElement('div');
    body.className = 'needs-body';

    needsDef.items.forEach(item => {
      let value = null;
      let achieved = false;
      const isInfo = item.type === 'info';

      if (item.type === 'rate' && item.calc) {
        value = item.calc(d);
        if (value !== null) achieved = value >= item.threshold;
      } else if (item.type === 'num') {
        value = d[item.key];
        if (value !== null) achieved = value >= item.threshold;
      } else if (item.type === 'flag') {
        value = d[item.key];
        achieved = value == 1;
      } else if (item.type === 'flag_str') {
        value = d[item.key];
        achieved = value == 1 || value === 'å…¬é–‹';
      } else if (item.type === 'deadline') {
        value = d[item.key];
        if (value !== null) achieved = value <= item.threshold;
      } else if (isInfo) {
        value = d[item.key];
      }

      // infoå‹ã¯é”æˆã‚«ã‚¦ãƒ³ãƒˆã«å«ã‚ãªã„
      if (!isInfo) {
        totalCount++;
        if (achieved) totalAchieved++;
        else totalUnachieved++;
      }

      const itemEl = document.createElement('div');
      itemEl.className = isInfo ? 'kpi-item info-item' : `kpi-item ${achieved ? 'achieved' : 'unachieved'}`;

      // å€¤ã®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ
      let valueText = '';
      if (item.type === 'rate') {
        valueText = value !== null ? `${value.toFixed(1)}% / ç›®æ¨™ ${item.threshold}%` : 'â€•';
      } else if (item.type === 'num') {
        valueText = value !== null ? `${value}${item.unit} / ç›®æ¨™ ${item.threshold}${item.unit}` : 'â€•';
      } else if (item.type === 'flag' || item.type === 'flag_str') {
        valueText = achieved ? 'è¨­å®šæ¸ˆã¿ âœ“' : 'æœªè¨­å®š';
      } else if (item.type === 'deadline') {
        valueText = value !== null ? `${value}åˆ† / ç›®æ¨™ ${item.threshold}åˆ†ä»¥å†…` : 'â€•';
      } else if (isInfo) {
        valueText = value !== null ? `${value}${item.unit}` : 'â€•';
      }

      const pointBadge = item.searchPoint
        ? `<span class="kpi-point-badge">â˜… ${item.point ? item.point + 'pt' : 'ãƒã‚¤ãƒ³ãƒˆå¯¾è±¡'}</span>`
        : '';

      const statusIcon = isInfo ? 'â€•' : (achieved ? 'âœ“' : '!');
      const statusClass = isInfo ? 'info' : (achieved ? 'ok' : 'ng');

      itemEl.innerHTML = `
        <div class="kpi-status ${statusClass}">${statusIcon}</div>
        <div class="kpi-main">
          <div class="kpi-name-row">
            <span class="kpi-name">${item.name}</span>
            ${pointBadge}
          </div>
          <div class="kpi-values">
            <span class="current ${statusClass}">${valueText}</span>
          </div>
          ${!isInfo && !achieved && ACTIONS[item.key] ? renderAction(item.key) : ''}
        </div>
      `;

      body.appendChild(itemEl);
    });

    section.appendChild(body);
    sectionsEl.appendChild(section);
  });

  // ã‚µãƒãƒªãƒ¼æ›´æ–°
  document.getElementById('achieved-count').textContent = totalAchieved;
  document.getElementById('unachieved-count').textContent = totalUnachieved;
  document.getElementById('total-count').textContent = totalCount;

  // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•
  if (trendData.length >= 2) {
    renderTrendCharts();
  }

  // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  // ã‚¢ãƒ‰ãƒã‚¤ã‚¹æç”»
  renderAdvice(d);

  // ãƒ©ã‚¤ãƒ³å•ã„åˆã‚ã›URLæ›´æ–°
  document.querySelector('.contact-btn.line').href = LINE_URL;
}

function renderAction(key) {
  const action = ACTIONS[key];
  if (!action) return '';

  const links = action.links.map(link => {
    if (link.url) {
      return `<a href="${link.url}" target="_blank" class="action-link primary">${link.label}</a>`;
    }
    return `<button class="action-link" onclick="handleActionClick('${link.action}')">${link.label}</button>`;
  }).join('');

  return `
    <div class="action-box">
      <div class="action-title">âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
      <div>${action.text}</div>
      <div class="action-links">${links}</div>
    </div>
  `;
}

function handleActionClick(action) {
  if (action === 'scroll_search') document.getElementById('needs-search')?.scrollIntoView({ behavior: 'smooth' });
  if (action === 'scroll_click') document.getElementById('needs-click')?.scrollIntoView({ behavior: 'smooth' });
  if (action === 'scroll_reserve') document.getElementById('needs-reserve')?.scrollIntoView({ behavior: 'smooth' });
  if (action === 'show_qr') alert('QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚æ‹…å½“è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚');
}

// ===== ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ =====
function generateAdvice(d) {
  const access = d.access || 0;
  const click = d.click || 0;
  const net_reserve = d.net_reserve || 0;
  const review = d.review || 0;
  const ctr = access > 0 ? (click / access * 100) : 0;
  const cvr = click > 0 ? (net_reserve / click * 100) : 0;

  if (access < 100) {
    return [
      'åº—èˆ—PRæƒ…å ±ã‚’ç®¡ç†ç”»é¢ã‹ã‚‰ä»Šæ—¥ä¸­ã«ç™»éŒ²ã™ã‚‹ï¼ˆæ¤œç´¢å„ªå…ˆ+100ptï¼‰',
      'ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ã‚³ãƒ³ãƒ‘ã‚¹ã¸ã®ç›¸äº’ãƒªãƒ³ã‚¯ã‚’è¨­ç½®ã™ã‚‹ï¼ˆ+30ptï¼‰',
      'Googleãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«ã‚³ãƒ³ãƒ‘ã‚¹ã®URLãƒ»äºˆç´„URLã‚’è¨­ç½®ã™ã‚‹ï¼ˆ+50ptï¼‰'
    ];
  }

  if (access < 200) {
    return [
      'ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«äºˆç´„ãƒãƒŠãƒ¼ã‚’è¨­ç½®ã—ã¦å¤–éƒ¨ã‹ã‚‰ã®èª˜å°ã‚’å¼·åŒ–ã™ã‚‹ï¼ˆ+50ptï¼‰',
      'Googleãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸ã®URLè¨­ç½®ã‚’ç¢ºèªãƒ»è¨­å®šã™ã‚‹',
      'åº—èˆ—PRæƒ…å ±ã®å†…å®¹ã‚’è¦‹ç›´ã—ã€ã‚ˆã‚Šé­…åŠ›çš„ã«å……å®Ÿã•ã›ã‚‹'
    ];
  }

  if (ctr < 5) {
    return [
      'æ¥é™¢ã—ãŸæ‚£è€…ã•ã‚“ã«å£ã‚³ãƒŸæŠ•ç¨¿ã‚’ãŠé¡˜ã„ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’ä»Šæ—¥ã‹ã‚‰æ¸¡ã™',
      'æ—¢å­˜ã®å£ã‚³ãƒŸå…¨ä»¶ã«ä¸å¯§ã«è¿”ä¿¡ã™ã‚‹',
      'PickUpå£ã‚³ãƒŸã«ç‰¹ã«å°è±¡çš„ãªæ‚£è€…ã•ã‚“ã®å£°ã‚’è¨­å®šã™ã‚‹'
    ];
  }

  if (ctr < 10) {
    return [
      'æœªè¿”ä¿¡ã®å£ã‚³ãƒŸã«1ä»¶ä¸å¯§ã«è¿”ä¿¡ã™ã‚‹',
      'PickUpå£ã‚³ãƒŸã‚’æœ€ã‚‚ä¿¡é ¼æ„ŸãŒé«˜ã¾ã‚‹å£ã‚³ãƒŸã«æ›´æ–°ã™ã‚‹',
      'å£ã‚³ãƒŸãƒ‘ãƒ¼ãƒ„ã‚’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«è¨­ç½®ã—ã¦ä¿¡é ¼æ„Ÿã‚’é«˜ã‚ã‚‹ï¼ˆ+30ptï¼‰'
    ];
  }

  if (cvr < 5) {
    return [
      'äºˆç´„å—ä»˜ã®ç· åˆ‡æ™‚é–“ã‚’çŸ­ç¸®ã—ã¦ç›´å‰äºˆç´„ã‚’é€ƒã•ãªã„ã‚ˆã†ã«ã™ã‚‹',
      'ã‚²ã‚¹ãƒˆäºˆç´„ã‚’æœ‰åŠ¹ã«ã—ã¦åˆè¨ºã®æ–¹ã®äºˆç´„ãƒãƒ¼ãƒ‰ãƒ«ã‚’ä¸‹ã’ã‚‹',
      'å—ä»˜å¯èƒ½ãªæ™‚é–“å¸¯ã‚’è¦‹ç›´ã—ã€ã§ãã‚‹é™ã‚Šåºƒã’ã‚‹'
    ];
  }

  if (cvr < 10) {
    return [
      'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨äºˆç´„ã®é€£æºè¨­å®šã‚’è¡Œã„ã€äºˆç´„ã—ã‚„ã™ã„å°ç·šã‚’æ•´ãˆã‚‹',
      'ã‚²ã‚¹ãƒˆäºˆç´„ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç®¡ç†ç”»é¢ã§ç¢ºèªã™ã‚‹',
      'äºˆç´„å—ä»˜ã®ç· åˆ‡æ™‚é–“ã‚’ã•ã‚‰ã«çŸ­ç¸®ã—ã¦ç›´å‰äºˆç´„ã‚’å–ã‚Šè¾¼ã‚€'
    ];
  }

  if (review < 5) {
    return [
      'é™¢å†…ã«å£ã‚³ãƒŸä¾é ¼ã®POPã‚’1æšè¨­ç½®ã™ã‚‹',
      'ä¼šè¨ˆæ™‚ã«æ‚£è€…ã•ã‚“ã¸å£ã‚³ãƒŸæŠ•ç¨¿ã®ãŠé¡˜ã„ã‚’ä¸€è¨€æ·»ãˆã‚‹ç¿’æ…£ã‚’ã¤ã‘ã‚‹',
      'æŠ•ç¨¿ã„ãŸã ã„ãŸå£ã‚³ãƒŸå…¨ä»¶ã«ä¸å¯§ãªè¿”ä¿¡ã‚’è¡Œã†'
    ];
  }

  return [
    'å£ã‚³ãƒŸã‚’ã‚ã¨1ä»¶å¢—ã‚„ã™ã“ã¨ã‚’ä»Šæœˆã®ç›®æ¨™ã«ã™ã‚‹',
    'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª¬æ˜æ–‡ã‚’ã‚ˆã‚Šé­…åŠ›çš„ã«è¦‹ç›´ã™',
    'å£ã‚³ãƒŸè¿”ä¿¡ã®è³ªã‚’é«˜ã‚ã¦æ‚£è€…ã•ã‚“ã¨ã®ä¿¡é ¼é–¢ä¿‚ã‚’æ·±ã‚ã‚‹'
  ];
}

function renderAdvice(d) {
  const actions = generateAdvice(d);
  const body = document.getElementById('advice-body');
  body.innerHTML = `
    <p class="advice-intro">é›†å®¢ã«ã¤ãªãŒã‚‹ä»Šã™ãå‡ºæ¥ã‚‹äº‹</p>
    <ol class="advice-actions">
      ${actions.map(a => `<li>${a}</li>`).join('')}
    </ol>
  `;
  document.getElementById('advice-section').style.display = 'block';
}

// ===== ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ =====
function renderTrendCharts() {
  document.getElementById('trend-section').style.display = 'block';

  const labels = trendData.map(t => formatSheetName(t.sheet));
  const accessData = trendData.map(t => t.data.access || 0);
  const ctrData = trendData.map(t => t.data.click && t.data.access ? parseFloat((t.data.click / t.data.access * 100).toFixed(1)) : 0);
  const cvrData = trendData.map(t => t.data.net_reserve && t.data.click ? parseFloat((t.data.net_reserve / t.data.click * 100).toFixed(1)) : 0);
  const reviewData = trendData.map(t => t.data.review || 0);

  const makeChart = (id, data, color, label, threshold) => {
    if (charts[id]) charts[id].destroy();
    const ctx = document.getElementById(id)?.getContext('2d');
    if (!ctx) return;
    charts[id] = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label,
          data,
          borderColor: color,
          backgroundColor: color + '20',
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
          x: { grid: { display: false } }
        }
      }
    });
  };

  makeChart('chart-access', accessData, '#0f4c81', 'ã‚¢ã‚¯ã‚»ã‚¹æ•°', 200);
  makeChart('chart-ctr', ctrData, '#2563EB', 'ã‚¯ãƒªãƒƒã‚¯ç‡(%)', 10);
  makeChart('chart-cvr', cvrData, '#e67e22', 'ãƒãƒƒãƒˆäºˆç´„ç‡(%)', 10);
  makeChart('chart-review', reviewData, '#00a86b', 'å£ã‚³ãƒŸä»¶æ•°', 5);
}

// ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
function handleLogout() {
  currentData = null;
  trendData = [];
  Object.values(charts).forEach(c => c.destroy());
  charts = {};
  document.getElementById('salon-id-input').value = '';
  document.getElementById('email-input').value = '';
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('kpi-sections').innerHTML = '';
  document.getElementById('trend-section').style.display = 'none';
}

// Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
document.getElementById('salon-id-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleLogin();
});
document.getElementById('email-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleLogin();
});
</script>
</body>
</html>
